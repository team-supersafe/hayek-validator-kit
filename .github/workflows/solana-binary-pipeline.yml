name: solana-binary-pipeline

on:
  workflow_dispatch:
    inputs:
      client:
        description: "Client to process"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - agave
          - jito-solana
      version:
        description: "Version (example: 3.0.14)"
        required: true
        type: string
      arch:
        description: "Architecture target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - x86_64
          - aarch64
      dry_run:
        description: "Plan only (skip actual build jobs)"
        required: true
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
    steps:
      - name: Build matrix from inputs
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          clients_json='["agave","jito-solana"]'
          if [[ "${{ inputs.client }}" != "all" ]]; then
            clients_json='["${{ inputs.client }}"]'
          fi

          arch_json='["x86_64","aarch64"]'
          if [[ "${{ inputs.arch }}" != "all" ]]; then
            arch_json='["${{ inputs.arch }}"]'
          fi

          matrix="$(jq -cn --argjson clients "$clients_json" --argjson arches "$arch_json" '
            [ $clients[] as $c | $arches[] as $a |
              {
                client: $c,
                arch: $a,
                runner: (if $a == "aarch64" then "ubuntu-24.04-arm" else "ubuntu-latest" end)
              }
            ]'
          )"

          echo "matrix=$matrix" >>"$GITHUB_OUTPUT"
          echo "$matrix" | jq '.'

  binary-pipeline:
    needs: plan
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.plan.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute release key
        id: release-key
        shell: bash
        run: |
          set -euo pipefail
          version="${{ inputs.version }}"
          client="${{ matrix.client }}"
          arch="${{ matrix.arch }}"

          if [[ "$client" == "agave" ]]; then
            key="agave/releases/download/v${version}/solana-release-${arch}-unknown-linux-gnu.tar.bz2"
          else
            key="jito-solana/releases/download/v${version}-jito/solana-release-${arch}-unknown-linux-gnu.tar.bz2"
          fi

          echo "s3_key=$key" >>"$GITHUB_OUTPUT"
          echo "release_url=https://solv-store.s3.us-east-1.amazonaws.com/${key}" >>"$GITHUB_OUTPUT"

      - name: Matrix item summary
        shell: bash
        run: |
          echo "client=${{ matrix.client }}"
          echo "version=${{ inputs.version }}"
          echo "arch=${{ matrix.arch }}"
          echo "runner=${{ matrix.runner }}"
          echo "s3_key=${{ steps.release-key.outputs.s3_key }}"
          echo "release_url=${{ steps.release-key.outputs.release_url }}"

      - name: Dry-run item
        if: inputs.dry_run
        shell: bash
        run: |
          echo "dry_run=true, skipping build for this matrix item."

      - name: Install build dependencies
        if: ${{ !inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            libudev-dev \
            llvm \
            libclang-dev \
            libssl-dev \
            protobuf-compiler \
            cmake \
            git \
            curl \
            wget \
            unzip \
            ca-certificates \
            zlib1g-dev \
            libprotobuf-dev \
            jq

      - name: Setup Rust toolchain
        if: ${{ !inputs.dry_run }}
        uses: dtolnay/rust-toolchain@stable

      - name: Build archive
        if: ${{ !inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          ./solana-localnet/build-solana-cli/build-cli-no-upload.sh \
            "${{ matrix.client }}" \
            "${{ inputs.version }}" \
            "${{ matrix.arch }}" \
            out \
            "out/metadata-${{ matrix.client }}-${{ matrix.arch }}.json"

      - name: Upload binary artifact
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: build-archive-${{ matrix.client }}-${{ matrix.arch }}-v${{ inputs.version }}
          path: out/solana-release-${{ matrix.arch }}-unknown-linux-gnu.tar.bz2
          if-no-files-found: error

      - name: Upload metadata artifact
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: build-meta-${{ matrix.client }}-${{ matrix.arch }}-v${{ inputs.version }}
          path: out/metadata-${{ matrix.client }}-${{ matrix.arch }}.json
          if-no-files-found: error

  manifest:
    if: ${{ !inputs.dry_run }}
    needs: binary-pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Download metadata artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-meta-*-v${{ inputs.version }}
          path: metadata
          merge-multiple: true

      - name: Build combined manifest
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          files=(metadata/metadata-*.json)
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No metadata files found to build manifest."
            exit 1
          fi

          mkdir -p out
          jq -s \
            --arg version "${{ inputs.version }}" \
            --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              version: $version,
              generated_at: $generated_at,
              entries: (sort_by(.client, .arch))
            }' \
            "${files[@]}" >out/manifest.json

          echo "Manifest generated at out/manifest.json"
          cat out/manifest.json

      - name: Upload combined manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-manifest-v${{ inputs.version }}
          path: out/manifest.json
          if-no-files-found: error
