name: solana-binary-promote

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to promote (example: 3.0.14)"
        required: true
        type: string
      client:
        description: "Client to promote"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - agave
          - jito-solana
      arch:
        description: "Architecture to promote"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - x86_64
          - aarch64
      source_bucket:
        description: "Source S3 bucket (staging artifacts)"
        required: true
        default: "solv-store"
        type: string
      source_prefix:
        description: "Source S3 prefix"
        required: true
        default: "staging"
        type: string
      destination_bucket:
        description: "Destination S3 bucket (release artifacts)"
        required: true
        default: "solv-store"
        type: string
      destination_prefix:
        description: "Destination S3 prefix (empty means release root)"
        required: false
        default: ""
        type: string
      aws_region:
        description: "AWS region"
        required: true
        default: "us-east-1"
        type: string
      dry_run:
        description: "Plan only (validate staging objects, no copy)"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
    steps:
      - name: Build promotion matrix from inputs
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          clients_json='["agave","jito-solana"]'
          if [[ "${{ inputs.client }}" != "all" ]]; then
            clients_json='["${{ inputs.client }}"]'
          fi

          arch_json='["x86_64","aarch64"]'
          if [[ "${{ inputs.arch }}" != "all" ]]; then
            arch_json='["${{ inputs.arch }}"]'
          fi

          matrix="$(jq -cn --argjson clients "$clients_json" --argjson arches "$arch_json" '
            [ $clients[] as $c | $arches[] as $a |
              {
                client: $c,
                arch: $a
              }
            ]'
          )"

          echo "matrix=$matrix" >>"$GITHUB_OUTPUT"
          echo "$matrix" | jq '.'

  promote:
    needs: plan
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.plan.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate promotion AWS secrets
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${AWS_ACCESS_KEY_ID}" || -z "${AWS_SECRET_ACCESS_KEY}" ]]; then
            echo "Missing required secrets for promotion:"
            echo "- SOLANA_BINARY_UPLOAD_AWS_ACCESS_KEY_ID"
            echo "- SOLANA_BINARY_UPLOAD_AWS_SECRET_ACCESS_KEY"
            exit 1
          fi

      - name: Configure AWS credentials (promotion)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Promote staging object to release key
        shell: bash
        run: |
          set -euo pipefail

          join_key() {
            local prefix="$1"
            local key="$2"
            if [[ -z "$prefix" ]]; then
              printf '%s' "$key"
            else
              printf '%s/%s' "${prefix%/}" "$key"
            fi
          }

          version="${{ inputs.version }}"
          client="${{ matrix.client }}"
          arch="${{ matrix.arch }}"

          if [[ "$client" == "agave" ]]; then
            release_key="agave/releases/download/v${version}/solana-release-${arch}-unknown-linux-gnu.tar.bz2"
          else
            release_key="jito-solana/releases/download/v${version}-jito/solana-release-${arch}-unknown-linux-gnu.tar.bz2"
          fi

          source_bucket="${{ inputs.source_bucket }}"
          source_prefix="${{ inputs.source_prefix }}"
          destination_bucket="${{ inputs.destination_bucket }}"
          destination_prefix="${{ inputs.destination_prefix }}"

          source_key="$(join_key "$source_prefix" "$release_key")"
          destination_key="$(join_key "$destination_prefix" "$release_key")"
          source_sha256_key="${source_key}.sha256"
          destination_sha256_key="${destination_key}.sha256"

          echo "client=$client"
          echo "arch=$arch"
          echo "release_key=$release_key"
          echo "source=s3://${source_bucket}/${source_key}"
          echo "destination=s3://${destination_bucket}/${destination_key}"

          aws s3api head-object --bucket "$source_bucket" --key "$source_key" >/dev/null
          aws s3api head-object --bucket "$source_bucket" --key "$source_sha256_key" >/dev/null

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "dry_run=true, skipping copy."
          else
            aws s3 cp \
              "s3://${source_bucket}/${source_key}" \
              "s3://${destination_bucket}/${destination_key}" \
              --only-show-errors

            aws s3 cp \
              "s3://${source_bucket}/${source_sha256_key}" \
              "s3://${destination_bucket}/${destination_sha256_key}" \
              --only-show-errors
          fi

          mkdir -p out
          jq -n \
            --arg version "$version" \
            --arg client "$client" \
            --arg arch "$arch" \
            --arg release_key "$release_key" \
            --arg source_bucket "$source_bucket" \
            --arg source_key "$source_key" \
            --arg destination_bucket "$destination_bucket" \
            --arg destination_key "$destination_key" \
            --arg destination_url "https://${destination_bucket}.s3.amazonaws.com/${destination_key}" \
            --arg destination_sha256_url "https://${destination_bucket}.s3.amazonaws.com/${destination_sha256_key}" \
            --arg dry_run "${{ inputs.dry_run }}" \
            --arg promoted_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              version: $version,
              client: $client,
              arch: $arch,
              release_key: $release_key,
              source_bucket: $source_bucket,
              source_key: $source_key,
              destination_bucket: $destination_bucket,
              destination_key: $destination_key,
              destination_url: $destination_url,
              destination_sha256_url: $destination_sha256_url,
              dry_run: ($dry_run == "true"),
              promoted_at: $promoted_at
            }' >"out/promote-meta-${client}-${arch}.json"

      - name: Upload promotion metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: promote-meta-${{ matrix.client }}-${{ matrix.arch }}-v${{ inputs.version }}
          path: out/promote-meta-${{ matrix.client }}-${{ matrix.arch }}.json
          if-no-files-found: error

  publish-release-manifest:
    needs: promote
    runs-on: ubuntu-latest
    steps:
      - name: Validate promotion AWS secrets
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${AWS_ACCESS_KEY_ID}" || -z "${AWS_SECRET_ACCESS_KEY}" ]]; then
            echo "Missing required secrets for manifest publication:"
            echo "- SOLANA_BINARY_UPLOAD_AWS_ACCESS_KEY_ID"
            echo "- SOLANA_BINARY_UPLOAD_AWS_SECRET_ACCESS_KEY"
            exit 1
          fi

      - name: Configure AWS credentials (manifest publication)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.SOLANA_BINARY_UPLOAD_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Download promotion metadata artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: promote-meta-*-v${{ inputs.version }}
          path: metadata
          merge-multiple: true

      - name: Build release manifest
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          files=(metadata/promote-meta-*.json)
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No promotion metadata files found."
            exit 1
          fi

          mkdir -p out
          jq -s \
            --arg version "${{ inputs.version }}" \
            --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg source_bucket "${{ inputs.source_bucket }}" \
            --arg source_prefix "${{ inputs.source_prefix }}" \
            --arg destination_bucket "${{ inputs.destination_bucket }}" \
            --arg destination_prefix "${{ inputs.destination_prefix }}" \
            --arg dry_run "${{ inputs.dry_run }}" \
            '{
              version: $version,
              generated_at: $generated_at,
              source_bucket: $source_bucket,
              source_prefix: $source_prefix,
              destination_bucket: $destination_bucket,
              destination_prefix: $destination_prefix,
              dry_run: ($dry_run == "true"),
              entries: (sort_by(.client, .arch))
            }' \
            "${files[@]}" >out/manifest-release.json

          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum out/manifest-release.json >out/manifest-release.json.sha256
          else
            shasum -a 256 out/manifest-release.json >out/manifest-release.json.sha256
          fi

          cat out/manifest-release.json
          cat out/manifest-release.json.sha256

      - name: Upload release manifest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-manifest-v${{ inputs.version }}
          path: |
            out/manifest-release.json
            out/manifest-release.json.sha256
          if-no-files-found: error

      - name: Publish release manifest to S3
        if: ${{ !inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail
          prefix="${{ inputs.destination_prefix }}"
          bucket="${{ inputs.destination_bucket }}"
          version="${{ inputs.version }}"

          if [[ -z "$prefix" ]]; then
            manifest_key="manifests/solana-binary-manifest-v${version}.json"
          else
            manifest_key="${prefix%/}/manifests/solana-binary-manifest-v${version}.json"
          fi

          aws s3 cp out/manifest-release.json "s3://${bucket}/${manifest_key}" --only-show-errors
          aws s3 cp out/manifest-release.json.sha256 "s3://${bucket}/${manifest_key}.sha256" --only-show-errors

          echo "published_manifest=s3://${bucket}/${manifest_key}"
          echo "published_manifest_sha256=s3://${bucket}/${manifest_key}.sha256"
