---
scenario:
  name: iam_manager_tests

dependency:
  name: shell
  command: |
    cd /hayek-validator-kit/ansible-tests
    DOCKER_BUILDKIT=1 docker build --target naked-builder -t molecule-host-alpha .

driver:
  name: docker

platforms:
  - name: iam-manager-tests
    image: molecule-host-alpha
    pre_build_image: true
    privileged: true
    volumes:
      - "/sys/fs/cgroup:/sys/fs/cgroup:rw"
      # SSH agent mount (fallback to /dev/null if not provided externally)
      - "${SSH_AUTH_SOCK:-/dev/null}:/ssh-agent:ro"
      - "/tmp/molecule_ssh_keys:/tmp/team_ssh_public_keys:ro"
    tmpfs:
      - /run
      - /run/lock
    environment:
      DEFAULT_USERNAME: ubuntu
      SSH_AUTH_SOCK: /ssh-agent
    command: |
      bash -c "
      # Create ubuntu user if it doesn't exist (like docker-compose does)
      id -u ubuntu >/dev/null 2>&1 || adduser --disabled-password --gecos \"\" ubuntu

      /opt/scripts/setup-ssh-keys.sh ubuntu
      /lib/systemd/systemd
      "

provisioner:
  name: ansible
  playbooks:
    prepare: prepare.yml
    converge: converge.yml
    verify: verify.yml
  env:
    ANSIBLE_ROLES_PATH: "/hayek-validator-kit/ansible/roles"
    # Temporary workaround for ansible-core 2.19 strict conditionals breaking molecule-docker playbooks
    ALLOW_BROKEN_CONDITIONALS: "1"
  config_options:
    defaults:
      # Temporary workaround for ansible-core 2.19 strict conditionals breaking molecule-docker playbooks
      allow_broken_conditionals: true
  inventory:
    group_vars:
      all:
        ansible_python_interpreter: /usr/bin/python3
        ansible_user: ubuntu
        remote_tmp: /tmp/.ansible/tmp
        ansible_remote_tmp: /tmp/.ansible/tmp
        # Skip interactive pauses in testing
        skip_confirmation_pauses: true

verifier:
  name: ansible
