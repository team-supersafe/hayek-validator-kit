---
dependency:
  name: shell
  command: |
    cd "${MOLECULE_PROJECT_DIRECTORY}/../"
    DOCKER_BUILDKIT=1 docker build --target naked-builder -t molecule-host-alpha .

driver:
  name: docker

platforms:
  - name: testing-rbac
    image: molecule-host-alpha
    pre_build_image: true
    privileged: true
    volumes:
      - "/sys/fs/cgroup:/sys/fs/cgroup:rw"
      # SSH agent mount (fallback to /dev/null if not provided externally)
      - "${SSH_AUTH_SOCK:-/dev/null}:/ssh-agent:ro"
      - "/tmp/molecule_ssh_keys:/tmp/team_ssh_public_keys:ro"
    tmpfs:
      - /run
      - /run/lock
    environment:
      DEFAULT_USERNAME: ubuntu
      SSH_AUTH_SOCK: /ssh-agent
    command: |
      bash -c "
      # Create ubuntu user if it doesn't exist (like docker-compose does)
      id -u ubuntu >/dev/null 2>&1 || adduser --disabled-password --gecos \"\" ubuntu

      # set default user ssh authorized_keys
      rm -rf /home/\$$DEFAULT_USERNAME/.ssh
      mkdir -p /home/\$$DEFAULT_USERNAME/.ssh
      chmod 700 /home/\$$DEFAULT_USERNAME/.ssh

      # Clear authorized_keys before appending to avoid duplicates
      > /home/\$$DEFAULT_USERNAME/.ssh/authorized_keys
      for file in /tmp/team_ssh_public_keys/*; do
          [ -f \"\$$file\" ] || continue
          cat \$$file >> /home/\$$DEFAULT_USERNAME/.ssh/authorized_keys
          echo \"\" >> /home/\$$DEFAULT_USERNAME/.ssh/authorized_keys
      done

      # Deduplicate authorized_keys entries
      TEMP_AUTH_KEYS=\"/home/\$$DEFAULT_USERNAME/.ssh/authorized_keys.tmp\"
      awk '!seen[\$$0]++' /home/\$$DEFAULT_USERNAME/.ssh/authorized_keys > \$$TEMP_AUTH_KEYS
      mv \$$TEMP_AUTH_KEYS /home/\$$DEFAULT_USERNAME/.ssh/authorized_keys

      chmod 600 /home/\$$DEFAULT_USERNAME/.ssh/authorized_keys
      chown -R \$$DEFAULT_USERNAME:\$$DEFAULT_USERNAME /home/\$$DEFAULT_USERNAME/.ssh

      /lib/systemd/systemd
      "

provisioner:
  name: ansible
  playbooks:
    prepare: prepare.yml
    converge: converge.yml
    verify: verify.yml
  env:
    ANSIBLE_ROLES_PATH: "${MOLECULE_PROJECT_DIRECTORY}/../../ansible/roles"
    # Temporary workaround for ansible-core 2.19 strict conditionals breaking molecule-docker playbooks
    ALLOW_BROKEN_CONDITIONALS: "1"
  config_options:
    defaults:
      # Temporary workaround for ansible-core 2.19 strict conditionals breaking molecule-docker playbooks
      allow_broken_conditionals: true
  inventory:
    group_vars:
      all:
        ansible_python_interpreter: /usr/bin/python3
        ansible_user: root
        remote_tmp: /tmp/.ansible/tmp
        ansible_remote_tmp: /tmp/.ansible/tmp
        # Skip interactive pauses in testing
        skip_confirmation_pauses: true

verifier:
  name: ansible
