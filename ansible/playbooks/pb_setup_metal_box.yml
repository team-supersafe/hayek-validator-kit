---
# Playbook for initial setup of metal box server
# This playbook configures a new metal box for validator operations
# --------------------
# Usage:
# ------
# Run from /ansible directory:
#
# ansible-playbook playbooks/pb_setup_metal_box.yml \
#   -i solana_new_metal_box.yml \
#   -e "target_host=new-metal-box" \
#   -e "ansible_user=alice" \
#   -e "csv_file=authorized_ips.csv" \
#   -e "host_name=validator-nyc-01" \
#   -e "solana_cluster=testnet" \
#   -e "allow_unconventional_testnet_two_disk_layout=true" \
#   -K
#
# Extended vars:
# - host_name (OPTIONAL): OS hostname to set before reboot. If omitted, hostname is unchanged.
# - solana_cluster (REQUIRED only for special testnet two-disk mode)
# - allow_unconventional_testnet_two_disk_layout (OPTIONAL opt-in for special testnet two-disk mode)
#
# Reboot behavior:
# - At the end of setup, the playbook waits 10 seconds and then reboots automatically.
# - Press Ctrl+C during the countdown to abort before reboot.

- name: Setup Metal Box Server
  hosts: "{{ target_host }}"
  user: "{{ ansible_user }}"
  become: true
  pre_tasks:
    - name: Confirm target host before applying changes
      ansible.builtin.import_tasks: ../roles/common/tasks/confirm_target_host.yml

  roles:
    - server_initial_setup
