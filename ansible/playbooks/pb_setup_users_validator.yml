---
# Setup users for a Solana validator server
# --------------------
# Usage:
# ------
# Run from /ansible directory:
#
# NOTE:
#   Target host must inherit Solana baseline vars (group_vars/solana.yml).
#   Recommended: include the host under the `solana` group in inventory.
#
# ansible-playbook playbooks/pb_setup_users_validator.yml \
#   -i solana_new_metal_box.yml \
#   -e "target_host=new-metal-box" \
#   -e "ansible_user=ubuntu" \
#   -e "csv_file=iam_setup.csv" \
#   -e "users_base_dir=$HOME/new-metal-box"
#   # csv_file is REQUIRED
#   # users_base_dir is OPTIONAL (directory containing the CSV file)

- name: Setup server users
  hosts: "{{ target_host }}"
  user: "{{ ansible_user }}"
  become: true
  vars_files:
    - ../roles/iam_manager/vars/main.yml
  pre_tasks:
    # Check if 'sol' user exists in CSV
    - name: Read CSV to check for sol user
      community.general.read_csv:
        path: "{{ users_file }}"
        key: user
      register: users_csv_precheck
      delegate_to: localhost
      become: false

    - name: Check if sol user exists in CSV
      ansible.builtin.set_fact:
        sol_user_in_csv: "{{ solana_user in users_csv_precheck.dict.keys() }}"

    - name: Display sol user status
      ansible.builtin.debug:
        msg: "{{ solana_user }} user {{ 'found' if sol_user_in_csv | bool else 'NOT found' }} in CSV"

    # Check for validator_operators group in CSV
    - name: Check if validator_operators group exists in CSV
      ansible.builtin.set_fact:
        has_validator_operators: >-
          {{
            users_csv_precheck.dict.values() | selectattr('group_a', 'defined') | selectattr('group_a', 'equalto', rbac_roles.operators) | list | length > 0 or
            users_csv_precheck.dict.values() | selectattr('group_b', 'defined') | selectattr('group_b', 'equalto', rbac_roles.operators) | list | length > 0 or
            users_csv_precheck.dict.values() | selectattr('group_c', 'defined') | selectattr('group_c', 'equalto', rbac_roles.operators) | list | length > 0
          }}

    - name: Display validator_operators group status
      ansible.builtin.debug:
        msg: "Validator_operators group {{ 'found' if has_validator_operators | bool else 'NOT found' }} in CSV"

    # Check for validator_viewers group in CSV
    - name: Check if validator_viewers group exists in CSV
      ansible.builtin.set_fact:
        has_validator_viewers: >-
          {{
            users_csv_precheck.dict.values() | selectattr('group_a', 'defined') | selectattr('group_a', 'equalto', rbac_roles.viewers) | list | length > 0 or
            users_csv_precheck.dict.values() | selectattr('group_b', 'defined') | selectattr('group_b', 'equalto', rbac_roles.viewers) | list | length > 0 or
            users_csv_precheck.dict.values() | selectattr('group_c', 'defined') | selectattr('group_c', 'equalto', rbac_roles.viewers) | list | length > 0
          }}

    - name: Display validator_viewers group status
      ansible.builtin.debug:
        msg: "Validator_viewers group {{ 'found' if has_validator_viewers | bool else 'NOT found' }} in CSV"

    # Validate that 'sol' user exists in CSV
    - name: Ensure solana user exists in CSV for validator role
      ansible.builtin.assert:
        that:
          - sol_user_in_csv | bool
        fail_msg: |
          ❌ Security requirement: The '{{ solana_user }}' user must exist in the CSV.
          The CSV must contain a user named '{{ solana_user }}' when setting up a validator server.
          This user is required to run the Solana validator service.
        success_msg: "✅ Security check passed: '{{ solana_user }}' user found in CSV"
      delegate_to: localhost
      become: false
      run_once: true

    # Validate that at least one validator_operators user exists
    - name: Ensure at least one validator_operators user exists for validator role
      ansible.builtin.assert:
        that:
          - has_validator_operators | bool
        fail_msg: |
          ❌ Security requirement: At least one user with 'validator_operators' role must exist.
          The CSV must contain at least one user with the group 'validator_operators' when setting up a validator server.
        success_msg: "✅ Security check passed: At least one validator_operators user found"
      delegate_to: localhost
      become: false
      run_once: true

    - name: Confirm target host before applying changes
      ansible.builtin.import_tasks: ../roles/common/tasks/confirm_target_host.yml

  roles:
    - iam_manager
