---
# Jito Validator Setup
# -------------------
# Sets up a Solana validator with Jito client using BAM.
#
# Usage:
# ------
# Run from /ansible directory:
#
# syntax check
# ansible-playbook playbooks/pb_setup_validator_jito_v2.yml \
#   -i solana_setup_host.yml \
#   --limit host-charlie \
#   --syntax-check \
#   -e "target_host=host-charlie"
#
# Example running against production host
# ansible-playbook playbooks/pb_setup_validator_jito_v2.yml \
#   -i solana_setup_host.yml \
#   --limit hyk-lat-mia \
#   -e "target_host=hyk-lat-mia" \
#   -e "ansible_user=bob" \
#   -e "validator_name=hayek-mainnet" \
#   -e "validator_type=hot-spare" \
#   -e "solana_cluster=mainnet" \
#   -e "jito_version=3.1.8" \
#   -e "build_from_source=true" \
#   -e "use_official_repo=true" \
#   -K
#
# Example running against localnet host
# ansible-playbook playbooks/pb_setup_validator_jito_v2.yml \
#   -i solana_localnet.yml \
#   --limit host-charlie \
#   -e "target_host=host-charlie" \
#   -e "ansible_user=bob" \
#   -e "validator_name=demo2" \
#   -e "validator_type=hot-spare" \
#   -e "solana_cluster=localnet" \
#   -e "jito_version=3.1.8" \
#   -e "build_from_source=true" \
#   -e "use_official_repo=true" \
#   -e "force_host_cleanup=true" \
#   -e "run_poh_cpu_affinity_fix=true" \
#   -K
#
# Extended vars:
# - build_from_source (OPTIONAL): Build from source instead of using precompiled binaries.
# - use_official_repo (OPTIONAL): Use official repository instead of forked repository.
# - force_host_cleanup (OPTIONAL): Cleanup target host if it has validator data from a different cluster.
# - run_poh_cpu_affinity_fix (OPTIONAL): Pin validator process to specific CPU core to improve PoH stability.

- name: Install Jito Client with BAM
  hosts: "{{ target_host }}"
  user: "{{ ansible_user }}"
  become: false
  vars:
    jito_min_bam_version: "3.0.10"

  pre_tasks:
    - name: Assert required parameters are defined
      ansible.builtin.assert:
        that:
          - target_host is defined
          - ansible_user is defined
          - jito_version is defined
        fail_msg: >
          Missing required playbook variables: target_host, ansible_user, jito_version

    - name: Enforce minimum Jito version for BAM support
      ansible.builtin.assert:
        that:
          - jito_version is version(jito_min_bam_version, '>=')
        fail_msg: >-
          jito_version={{ jito_version }} is too old for BAM mode.
          Set jito_version >= {{ jito_min_bam_version }}.

    - name: Debug ansible_limit and target_host
      ansible.builtin.debug:
        msg:
          - "ansible_limit: {{ ansible_limit | default('not defined') }}"
          - "ansible_limit type: {{ ansible_limit | type_debug }}"
          - "target_host: {{ target_host }}"
          - "ansible_play_hosts: {{ ansible_play_hosts }}"

    - name: Validate that target_host matches the limited host
      ansible.builtin.assert:
        that:
          - ansible_limit is defined
          - target_host == ansible_limit
        fail_msg: >
          This playbook must be run with --limit to target exactly one host.
          Make sure you run this playbook with: --limit {{ target_host }} -e "target_host={{ target_host }}"

  roles:
    - role: solana_validator_jito_v2
