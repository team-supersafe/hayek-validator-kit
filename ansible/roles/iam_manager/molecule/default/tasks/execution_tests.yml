---
# ========================================
# RBAC VERIFICATION - REAL COMMAND EXECUTION TESTS
# ========================================

- name: "Build execution test matrix from existing classifications"
  ansible.builtin.set_fact:
    execution_matrix: |
      {%- set tests = [] -%}
      {%- for user in ['hugo', 'alice', 'sol', 'bob'] -%}
        {%- set role = 'viewer' if user == 'hugo' else 'operator' if user == 'alice' else 'admin' -%}
        {%- for cmd in ['whoami', 'id', 'pwd', 'ls /tmp'] -%}
          {%- set _ = tests.append({'user': user, 'cmd': cmd, 'expect': 'success', 'role': role, 'type': 'safe'}) -%}
        {%- endfor -%}
        {%- if role in ['viewer', 'operator'] -%}
          {%- for cmd in ['sudo -n whoami', 'sudo -n systemctl status', 'sudo -n cat /etc/shadow', 'sudo -n useradd testuser', 'sudo -n apt update', 'sudo -n apt install --dry-run nano', 'sudo -n systemctl stop ssh --dry-run'] -%}
            {%- set _ = tests.append({'user': user, 'cmd': cmd, 'expect': 'block', 'role': role, 'type': 'restricted'}) -%}
          {%- endfor -%}
        {%- else -%}
          {%- for cmd in ['sudo -n systemctl status {{ validator_service }}', 'sudo -n journalctl -u {{ validator_service }}', 'sudo -n apt update', 'sudo -n curl --version', 'sudo -n systemctl enable {{ validator_service }}'] -%}
            {%- set _ = tests.append({'user': user, 'cmd': cmd, 'expect': 'success', 'role': 'admin', 'type': 'admin'}) -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
      {{ tests | to_json }}

- name: "Execute command matrix with sudo -n for privilege testing"
  ansible.builtin.shell: "su - {{ item.user }} -c '{{ item.cmd | replace('{{ validator_service }}', validator_service) }}'"
  register: execution_results
  loop: "{{ execution_matrix | from_json }}"
  failed_when: false
  changed_when: true

- name: "Categorize sudo -n results intelligently"
  ansible.builtin.set_fact:
    categorized_results: |
      {%- set results = {'success': [], 'violations': [], 'expected_block': []} -%}
      {%- for i in range(execution_results.results | length) -%}
        {%- set result = execution_results.results[i] -%}
        {%- set test_info = (execution_matrix | from_json)[i] -%}
        {%- if result.rc == 1 and 'sudo: a password is required' in result.stderr and test_info.expect == 'block' -%}
          {%- set _ = results.expected_block.append({
              'test': test_info, 
              'result': result, 
              'reason': 'sudo_password_required',
              'status': 'SECURITY_CORRECT'
          }) -%}
        {%- elif result.rc == 0 and test_info.expect == 'block' -%}
          {%- set _ = results.violations.append({
              'test': test_info,
              'result': result,
              'reason': 'unauthorized_sudo_access',
              'status': 'SECURITY_VIOLATION'
          }) -%}
        {%- elif (result.rc == 0 or (test_info.cmd.find('systemctl status') != -1 and result.rc in [3, 4])) and test_info.expect == 'success' -%}
          {%- set _ = results.success.append({
              'test': test_info,
              'result': result,
              'reason': 'expected_success',
              'status': 'WORKING_CORRECTLY'
          }) -%}
        {%- elif result.rc != 0 and test_info.expect == 'success' and not (test_info.cmd.find('systemctl status') != -1 and result.rc in [3, 4]) -%}
          {%- set _ = results.violations.append({
              'test': test_info,
              'result': result,
              'reason': 'unexpected_failure',
              'status': 'COMMAND_BROKEN'
          }) -%}
        {%- else -%}
          {%- set _ = results.expected_block.append({
              'test': test_info,
              'result': result,
              'reason': 'other_block_mechanism',
              'status': 'SECURITY_WORKING'
          }) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ results }}

- name: "Set execution test summary for final report"
  ansible.builtin.set_fact:
    execution_tests_summary:
      total_tests: "{{ execution_matrix | from_json | length }}"
      successful_executions: "{{ categorized_results.success | length }}"
      expected_blocks: "{{ categorized_results.expected_block | length }}"
      violations: "{{ categorized_results.violations | length }}"
      status: "{{ 'PASSED' if (categorized_results.violations | length == 0) else 'FAILED' }}"
      sudo_password_blocks: "{{ categorized_results.expected_block | selectattr('reason', 'equalto', 'sudo_password_required') | list | length }}"

- name: "Build execution test breakdown display"
  ansible.builtin.set_fact:
    execution_breakdown_display: |
      {%- set lines = [] -%}
      
      {%- set _ = lines.append("========================================") -%}
      {%- set _ = lines.append("ðŸ“‹ EXECUTION TEST MATRIX EXPLAINED") -%}
      {%- set _ = lines.append("========================================") -%}
      {%- set _ = lines.append("") -%}
      {%- set _ = lines.append("ðŸ‘¥ USERS TESTED: hugo (viewer), alice (operator), sol (admin), bob (admin)") -%}
      {%- set _ = lines.append("ðŸŽ¯ TOTAL COMMANDS: " + (execution_tests_summary.total_tests | string) + " executions") -%}
      {%- set _ = lines.append("") -%}
      {%- set _ = lines.append("ðŸ“Š COMMAND CATEGORIES BREAKDOWN:") -%}
      {%- set _ = lines.append("") -%}
      {%- set _ = lines.append("ðŸŸ¢ BASIC COMMANDS (should work for everyone):") -%}
      {%- set _ = lines.append("   â€¢ Commands: whoami, id, pwd, ls /tmp") -%}
      {%- set _ = lines.append("   â€¢ Users: 4 (all users)") -%}
      {%- set _ = lines.append("   â€¢ Calculation: 4 commands Ã— 4 users = 16 executions") -%}
      {%- set _ = lines.append("   â€¢ Expected: ALL SUCCESS") -%}
      {%- set _ = lines.append("") -%}
      {%- set _ = lines.append("ðŸ”´ RESTRICTED COMMANDS (should be blocked for viewers/operators):") -%}
      {%- set _ = lines.append("   â€¢ Commands: sudo -n whoami, sudo -n systemctl status") -%}
      {%- set _ = lines.append("   â€¢           sudo -n cat /etc/shadow, sudo -n useradd") -%}
      {%- set _ = lines.append("   â€¢           sudo -n apt update/install, sudo -n systemctl stop") -%}
      {%- set _ = lines.append("   â€¢ Users: 2 (hugo=viewer, alice=operator)") -%}
      {%- set _ = lines.append("   â€¢ Calculation: 7 commands Ã— 2 restricted users = 14 blocks") -%}
      {%- set _ = lines.append("   â€¢ Expected: ALL BLOCKED") -%}
      {%- set _ = lines.append("") -%}
      {%- set _ = lines.append("ðŸŸ¡ ADMIN COMMANDS (should work for admins only):") -%}
      {%- set _ = lines.append("   â€¢ Commands: sudo -n systemctl status, sudo -n journalctl") -%}
      {%- set _ = lines.append("   â€¢           sudo -n curl, sudo -n apt update") -%}
      {%- set _ = lines.append("   â€¢           sudo -n systemctl enable") -%}
      {%- set _ = lines.append("   â€¢ Users: 2 (sol=admin, bob=admin)") -%}
      {%- set _ = lines.append("   â€¢ Calculation: 5 commands Ã— 2 admins = 10 executions") -%}
      {%- set _ = lines.append("   â€¢ Expected: ALL SUCCESS") -%}
      {%- set _ = lines.append("") -%}
      {%- set _ = lines.append("ðŸ§® MATH CHECK: 16 basic + 14 restricted + 10 admin = " + (execution_tests_summary.total_tests | string)) -%}
      {%- set _ = lines.append("========================================") -%}
      {{ lines }}

- name: "Explain execution test breakdown"
  ansible.builtin.debug:
    msg: "{{ execution_breakdown_display }}"

- name: "Build execution test results display"
  ansible.builtin.set_fact:
    execution_results_display: |
      {%- set lines = [] -%}
      
      {%- set _ = lines.append("========================================") -%}
      {%- set _ = lines.append("ðŸ“Š EXECUTION TESTS - DETAILED RESULTS") -%}
      {%- set _ = lines.append("========================================") -%}
      {%- set _ = lines.append("") -%}
      
      {%- if execution_tests_summary.violations | int == 0 -%}
        {%- set _ = lines.append("ðŸŽ¯ FINAL ANSWER: ALL TESTS PASSED âœ…") -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("ï¿½ EXECUTION STATISTICS:") -%}
        {%- set _ = lines.append("â€¢ Total commands tested: " + (execution_tests_summary.total_tests | string)) -%}
        {%- set _ = lines.append("â€¢ Basic commands successful: " + (execution_tests_summary.successful_executions | string)) -%}
        {%- set _ = lines.append("â€¢ Restricted commands blocked: " + (execution_tests_summary.expected_blocks | string)) -%}
        {%- set _ = lines.append("â€¢ Security violations found: " + (execution_tests_summary.violations | string)) -%}
        {%- set _ = lines.append("â€¢ Success rate: 100%") -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("âœ… SECURITY ANALYSIS:") -%}
        {%- set _ = lines.append("â€¢ All basic commands work for everyone") -%}
        {%- set _ = lines.append("â€¢ All restricted commands properly blocked") -%}
        {%- set _ = lines.append("â€¢ Admin commands work only for administrators") -%}
        {%- set _ = lines.append("â€¢ sudo -n password prompts working correctly") -%}
        {%- set _ = lines.append("â€¢ Least privilege principles enforced") -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("ðŸŽ¯ VERDICT: SECURITY IS PERFECT âœ…") -%}
        {%- set _ = lines.append("System ready for production deployment.") -%}
      {%- else -%}
        {%- set _ = lines.append("ðŸš¨ FINAL ANSWER: SECURITY BREACH DETECTED âŒ") -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("ðŸ“Š EXECUTION STATISTICS:") -%}
        {%- set _ = lines.append("â€¢ Total commands tested: " + (execution_tests_summary.total_tests | string)) -%}
        {%- set _ = lines.append("â€¢ Basic commands successful: " + (execution_tests_summary.successful_executions | string)) -%}
        {%- set _ = lines.append("â€¢ Restricted commands blocked: " + (execution_tests_summary.expected_blocks | string)) -%}
        {%- set _ = lines.append("â€¢ Security violations found: " + (execution_tests_summary.violations | string)) -%}
        {%- set _ = lines.append("â€¢ Success rate: " + (((execution_tests_summary.total_tests | int - execution_tests_summary.violations | int) / execution_tests_summary.total_tests | int * 100) | round(1) | string) + "%") -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("ðŸš¨ SECURITY PROBLEMS DETECTED:") -%}
        {%- if execution_tests_summary.violations | int > 0 -%}
          {%- set _ = lines.append("â€¢ " + (execution_tests_summary.violations | string) + " unauthorized command executions") -%}
          {%- set _ = lines.append("â€¢ Users can access restricted commands they shouldn't") -%}
          {%- set _ = lines.append("â€¢ RBAC permissions are incorrectly configured") -%}
        {%- endif -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("âš ï¸ ACTION REQUIRED:") -%}
        {%- set _ = lines.append("1. Review sudoers configuration") -%}
        {%- set _ = lines.append("2. Check role assignments in /etc/sudoers.d/") -%}
        {%- set _ = lines.append("3. Verify user group memberships") -%}
        {%- set _ = lines.append("4. Re-run tests until all violations are resolved") -%}
        {%- set _ = lines.append("") -%}
        {%- set _ = lines.append("ðŸ›‘ VERDICT: SECURITY NEEDS IMMEDIATE ATTENTION âŒ") -%}
        {%- set _ = lines.append("DO NOT DEPLOY TO PRODUCTION UNTIL RESOLVED!") -%}
      {%- endif -%}
      
      {%- set _ = lines.append("========================================") -%}
      {{ lines }}

- name: "Display execution test results"
  ansible.builtin.debug:
    msg: "{{ execution_results_display }}"

- name: "Display execution violations if any"
  ansible.builtin.debug:
    msg: "ðŸš¨ EXECUTION VIOLATION: User {{ item.test.user }} ({{ item.test.role }}) executed '{{ item.test.cmd }}' successfully when it should have been blocked!"
  loop: "{{ categorized_results.violations | default([]) }}"
  when: categorized_results.violations | length > 0
