---
# Pause to let user read the warning
- name: Notify about upcoming ubuntu user disablement
  ansible.builtin.debug:
    msg: |
      IMPORTANT WARNING: The ubuntu user will now be disabled.
      After this task completes, you will LOSE CONNECTION to this server.
      Please ensure you can connect with one of the newly created users:
      {% for user in users_csv.dict.keys() %}
      - {{ user }}
      {% endfor %}

- name: Pause for warning
  ansible.builtin.pause:
    prompt: "Press Enter to continue and disable ubuntu user (you will lose connection!), or Ctrl+C to abort"
  when: not (skip_confirmation_pauses | default(false))


- name: Disable ubuntu user completely (lock, remove sudo, block SSH, clean sudoers)
  ansible.builtin.shell: |
    usermod -L ubuntu
    usermod -s /usr/sbin/nologin ubuntu
    gpasswd -d ubuntu sudo || true
    gpasswd -d ubuntu admin || true
    sed -i '/^ubuntu[[:space:]]/d' /etc/sudoers || true
    rm -f /etc/sudoers.d/ubuntu /etc/sudoers.d/90-cloud-init-users /etc/sudoers.d/90-ubuntu-users
    find /etc/sudoers.d -type f -exec sed -i '/ubuntu/d' {} +
    grep -q '^DenyUsers' /etc/ssh/sshd_config && sed -i '/ubuntu/d' /etc/ssh/sshd_config
    echo 'DenyUsers ubuntu' >> /etc/ssh/sshd_config
    systemctl reload sshd || true
  become: true
  ignore_errors: true
