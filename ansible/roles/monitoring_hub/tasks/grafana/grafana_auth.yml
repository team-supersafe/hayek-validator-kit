---
# Grafana authentication and credentials tasks
# - Ensures admin password is set (idempotent)
# - Creates service account for automation (idempotent)

- name: Ensure Grafana admin password is set
  ansible.builtin.uri:
    url: "http://{{ monitoring_network.bind_address | default('localhost') }}:{{ grafana_port | default(3000) }}/api/admin/users/1/password"
    method: PUT
    user: "{{ grafana_default_admin_user }}"
    password: "{{ grafana_default_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      password: "{{ grafana_secrets.admin_password }}"
    status_code: [200, 401]
    timeout: 10
  when: grafana_secrets.admin_password is defined
  no_log: true

- name: Create Grafana service account
  ansible.builtin.uri:
    url: "http://{{ monitoring_network.bind_address | default('localhost') }}:{{ grafana_port | default(3000) }}/api/serviceaccounts"
    method: POST
    user: "{{ grafana_default_admin_user }}"
    password: "{{ grafana_secrets.admin_password }}"
    force_basic_auth: yes
    headers:
      Content-Type: "application/json"
    body: |
      {
        "name": "ansible-provisioner",
        "role": "Admin"
      }
    body_format: json
    status_code: [200, 201, 400]
    timeout: 15
    return_content: true
  register: grafana_service_account_response
  failed_when: >-
    grafana_service_account_response.status not in [200, 201, 400]
    or (grafana_service_account_response.status == 400 and (
      grafana_service_account_response.json is not defined
      or grafana_service_account_response.json.messageId != 'serviceaccounts.ErrAlreadyExists'
    ))
  changed_when: grafana_service_account_response.status in [200, 201]
