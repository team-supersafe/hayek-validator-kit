---
# InfluxDB configuration tasks

- name: Get InfluxDB organization ID
  ansible.builtin.uri:
    url: "http://localhost:{{ influxdb_port | default(8086) }}/api/v2/orgs?org={{ influxdb_init_org }}"
    method: GET
    headers:
      Authorization: "Token {{ influxdb_onboarding_token }}"
    status_code: 200
  register: influxdb_org_result
  when: influxdb_onboarding_token is defined

- ansible.builtin.set_fact:
    influxdb_org_id: "{{ influxdb_org_result.json.orgs[0].id }}"
  when: influxdb_org_result is defined and influxdb_org_result.json.orgs[0].id is defined

- name: Show InfluxDB onboarding token
  ansible.builtin.debug:
    msg: "InfluxDB onboarding token: {{ influxdb_onboarding_token }}"
  when: influxdb_onboarding_token is defined

- name: Create additional InfluxDB buckets
  ansible.builtin.uri:
    url: "http://localhost:{{ influxdb_port | default(8086) }}/api/v2/buckets"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_onboarding_token }}"
    body_format: json
    body:
      name: "{{ item.name }}"
      description: "{{ item.description }}"
      orgID: "{{ influxdb_org_id }}"
      retentionRules:
        - type: expire
          everySeconds: "{{ 0 if item.expectations == false else item.retention | int * 86400 }}"
    status_code: 201
  loop: "{{ influxdb_additional_buckets }}"
  when: influxdb_additional_buckets is defined and influxdb_onboarding_token is defined and influxdb_org_id is defined
  no_log: true

- name: Get bucket IDs for additional buckets
  ansible.builtin.uri:
    url: "http://localhost:{{ influxdb_port | default(8086) }}/api/v2/buckets?name={{ item.name }}"
    method: GET
    headers:
      Authorization: "Token {{ influxdb_onboarding_token }}"
    status_code: 200
  register: influxdb_bucket_result
  loop: "{{ influxdb_additional_buckets }}"
  loop_control:
    label: "{{ item.name }}"
  when: influxdb_onboarding_token is defined and influxdb_org_id is defined

- name: Set fact for bucket IDs
  ansible.builtin.set_fact:
    influxdb_bucket_ids: "{{ influxdb_bucket_ids | default({}) | combine({item.name: influxdb_bucket_result.results[index].json.buckets[0].id}) }}"
  loop: "{{ influxdb_additional_buckets }}"
  loop_control:
    label: "{{ item.name }}"
  vars:
    index: "{{ influxdb_additional_buckets.index(item) }}"
  when: influxdb_bucket_result.results[index].json.buckets | length > 0

- name: Create token for each bucket with dynamic permissions
  ansible.builtin.uri:
    url: "http://localhost:{{ influxdb_port | default(8086) }}/api/v2/authorizations"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_onboarding_token }}"
    body_format: json
    body:
      orgID: "{{ influxdb_org_id }}"
      description: "Token for {{ item.name }}"
      permissions: >-
        {{
          (
            [{
              'action': 'write',
              'resource': {
                'type': 'buckets',
                'id': influxdb_bucket_ids[item.name]
              }
            }] if (item.token_permissions_write | default(false)) else []
          )
          +
          (
            [{
              'action': 'read',
              'resource': {
                'type': 'buckets',
                'id': influxdb_bucket_ids[item.name]
              }
            }] if (item.token_permissions_read | default(false)) else []
          )
        }}
    status_code: 201
  register: influxdb_write_token_result
  loop: "{{ influxdb_additional_buckets }}"
  loop_control:
    label: "{{ item.name }}"
  when: influxdb_bucket_ids[item.name] is defined

- name: Set fact for bucket tokens dictionary (keyed by bucket name)
  ansible.builtin.set_fact:
    influxdb_bucket_tokens: >-
      {{
        dict(
          influxdb_write_token_result.results | map(attribute='item') | map(attribute='name') | list
          | zip(
            influxdb_write_token_result.results
            | map(attribute='json')
            | map(attribute='token')
          )
        )
      }}
  when: influxdb_write_token_result is defined

- name: Set fact for hardware_metrics token
  ansible.builtin.set_fact:
    hardware_metrics_token: "{{ influxdb_bucket_tokens[influxdb_additional_buckets[0].name] }}"
  when:
    - influxdb_bucket_tokens is defined
    - influxdb_additional_buckets | length > 0

- name: Set fact for solana_metrics token
  ansible.builtin.set_fact:
    solana_metrics_token: "{{ influxdb_bucket_tokens[influxdb_additional_buckets[1].name] }}"
  when:
    - influxdb_bucket_tokens is defined
    - influxdb_additional_buckets | length > 1

- name: Show write token for each bucket
  ansible.builtin.debug:
    msg: "Write token for {{ item.name }}: {{ influxdb_write_token_result.results[bucket_index].json.token }}"
  loop: "{{ influxdb_additional_buckets }}"
  loop_control:
    label: "{{ item.name }}"
    index_var: bucket_index
  when: influxdb_write_token_result.results[bucket_index].json.token is defined
