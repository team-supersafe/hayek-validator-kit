---
# monitoring_hub role main tasks

- name: Check monitoring hub secrets file exists
  ansible.builtin.stat:
    path: "{{ role_path }}/vars/secrets.yml"
  register: monitoring_hub_secrets_file

- name: Assert secrets file is present
  ansible.builtin.assert:
    that:
      - monitoring_hub_secrets_file.stat.exists
    fail_msg: >-
      Missing {{ role_path }}/vars/secrets.yml. Copy
      {{ role_path }}/vars/secrets.yml.example to secrets.yml and fill it with
      environment-specific values.
  no_log: true

- name: Include monitoring hub secrets variables
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/secrets.yml"
  no_log: true
  tags:
    - validator_metrics_service

- name: Run precheck tasks
  include_tasks: precheck.yml

- name: Configure Firewall rules
  include_tasks: config_firewall.yml
  tags: firewall

- name: Include monitoring hub installation tasks
  include_tasks: install.yml

- name: Include monitoring hub configuration tasks
  include_tasks: configure.yml

- name: Include InfluxDB tasks
  include_tasks: influxdb/main.yml

- name: Configure Grafana datasources (after InfluxDB tokens are ready)
  include_tasks: grafana/configure_datasources.yml
  tags: grafana

- name: Configure Telegraf
  include_tasks: telegraf/main.yml
  tags: telegraf

- name: Setup Solana validator metrics monitoring
  import_tasks: validator_metrics_service/main.yml
  tags: validator_metrics_service

- name: Setup Alerting (Watchtower)
  include_tasks: setup_alerting/main.yml
  tags: setup_alerting

- name: Setup SSL Certificates (Let's Encrypt + Cloudflare)
  include_tasks: ssl_certificates/main.yml
  when: (ssl_enabled | bool) and (not is_docker_container | bool)

- name: Summary report of monitoring hub setup
  include_tasks: summary.yml
