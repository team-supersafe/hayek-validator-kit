---
# monitoring_hub role main tasks

- name: Load sensitive variables
  include_vars: secrets.yml
  no_log: true
  tags:
    - validator_metrics_service

- name: Run precheck tasks
  include_tasks: precheck.yml

- name: Configure Firewall rules
  include_tasks: config_firewall.yml
  tags: firewall

- name: Include monitoring hub installation tasks
  include_tasks: install.yml

- name: Include monitoring hub configuration tasks
  include_tasks: configure.yml

- name: Include InfluxDB tasks
  include_tasks: influxdb/main.yml

- name: Configure Grafana datasources (after InfluxDB tokens are ready)
  include_tasks: grafana/configure_datasources.yml
  tags: grafana

- name: Configure Telegraf
  include_tasks: telegraf/main.yml
  tags: telegraf

- name: Setup Solana validator metrics monitoring
  import_tasks: validator_metrics_service/main.yml
  tags: validator_metrics_service

- name: Setup Alerting (Watchtower)
  include_tasks: setup_alerting/main.yml
  tags: setup_alerting

- name: Setup SSL Certificates (Let's Encrypt + Cloudflare)
  include_tasks: ssl_certificates/main.yml
  when: (ssl_enabled | bool) and (not is_docker_container | bool)

- name: Summary report of monitoring hub setup
  include_tasks: summary.yml
