---
# Configure Cloudflare credentials and issue certificate

- name: Ensure Cloudflare credentials directory exists
  ansible.builtin.file:
    path: /etc/letsencrypt
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create Cloudflare credentials file
  ansible.builtin.copy:
    dest: /etc/letsencrypt/cloudflare.ini
    content: |
      dns_cloudflare_api_token = {{ ssl_cloudflare_token }}
    owner: root
    group: root
    mode: '0600'
  no_log: true

- name: Issue SSL certificate with Certbot
  ansible.builtin.command:
    cmd: >
      certbot certonly
      --dns-cloudflare
      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini
      --non-interactive
      --agree-tos
      {{ '--test-cert' if ssl_staging | default(false) | bool else '' }}
      --email {{ ssl_email }}
      -d {{ ssl_domain }}
  args:
    creates: "/etc/letsencrypt/live/{{ ssl_domain }}/fullchain.pem"
  ignore_errors: false

- name: Ensure certbot automatic renewal systemd timer is enabled and running
  ansible.builtin.systemd:
    name: certbot.timer
    enabled: true
    state: started
- name: Ensure ssl-cert group has access to Let's Encrypt directories
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: ssl-cert
    mode: '0750'
    recurse: yes
  loop:
    - /etc/letsencrypt/live
    - /etc/letsencrypt/archive

- name: Create Certbot post-renewal hook to fix permissions and restart Grafana
  ansible.builtin.copy:
    dest: /etc/letsencrypt/renewal-hooks/post/99-fix-perms-restart-grafana.sh
    owner: root
    group: root
    mode: '0755'
    content: |
      #!/bin/bash
      set -e
      DOMAIN="{{ ssl_domain }}"
      # Fix permissions for live and archive directories
      chown -R root:ssl-cert /etc/letsencrypt/live/"$DOMAIN"
      chmod -R 750 /etc/letsencrypt/live/"$DOMAIN"
      chown -R root:ssl-cert /etc/letsencrypt/archive/"$DOMAIN"
      chmod -R 750 /etc/letsencrypt/archive/"$DOMAIN"
      # Restart Grafana to reload certificates
      systemctl restart grafana-server || true
  when: ssl_domain is defined

- name: Ensure certbot automatic renewal systemd timer is enabled and running
  ansible.builtin.systemd:
    name: certbot.timer
    enabled: true
    state: started

