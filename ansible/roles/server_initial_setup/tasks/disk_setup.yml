---
# This role performs disk setup and configuration for Solana validator
# This role uses disk information collected by precheck.yml

# Get available disks excluding those in use by the system (snapshots can be on root)
- name: Get available disks
  ansible.builtin.shell: |
    lsblk -b -d -o NAME,TYPE,SIZE | awk '$2 == "disk"' | sort -k3 -nr | while read name type size; do
      if ! grep -q "/dev/$name" /proc/mounts; then
        echo "$name"
      fi
    done
  register: available_disks_list
  changed_when: false

# Get root device for snapshots if needed
- name: Get root device
  ansible.builtin.shell: |
    findmnt -n -o SOURCE /
  register: root_device
  changed_when: false

# Assign disks by size, use root for snapshots if not enough disks
- name: Assign disks by size (snapshots on root if needed)
  ansible.builtin.set_fact:
    ledger_disk: "{{ available_disks_list.stdout_lines[0] if available_disks_list.stdout_lines | length > 0 else '' }}"
    account_disk: "{{ available_disks_list.stdout_lines[1] if available_disks_list.stdout_lines | length > 1 else '' }}"
    snapshots_disk: >-
      {{
        (available_disks_list.stdout_lines[2] if available_disks_list.stdout_lines | length > 2
          else (
            (root_device.stdout | regex_replace('^/dev/', '')).split('p')[0] if 'nvme' in root_device.stdout
            else (root_device.stdout | regex_replace('^/dev/', '') | regex_replace('[0-9]+$', ''))
          )
      )
      }}

# Fail early if any assigned disk is not present in ansible_facts['devices']
- name: Fail if any assigned disk is not present in ansible_facts['devices']
  ansible.builtin.assert:
    that:
      - ledger_disk == '' or ledger_disk in ansible_facts['devices']
      - account_disk == '' or account_disk in ansible_facts['devices']
      - snapshots_disk == '' or snapshots_disk in ansible_facts['devices']
    fail_msg: |
      One or more assigned disks (ledger, accounts, snapshots) are not present in ansible_facts['devices'].
      ledger_disk: {{ ledger_disk }}
      account_disk: {{ account_disk }}
      snapshots_disk: {{ snapshots_disk }}
      Available devices: {{ ansible_facts['devices'].keys() | list }}

# Display disk assignments for verification
- name: Show disk assignments
  ansible.builtin.debug:
    msg: |
      Detected disk assignments:
      - Ledger: /dev/{{ ledger_disk }} ({{ ansible_facts['devices'][ledger_disk].size if ledger_disk in ansible_facts['devices'] else 'Not available' }})
      - Accounts: /dev/{{ account_disk }} ({{ ansible_facts['devices'][account_disk].size if account_disk in ansible_facts['devices'] else 'Not available' }})
      - Snapshots: /dev/{{ snapshots_disk }} ({{ ansible_facts['devices'][snapshots_disk].size if snapshots_disk in ansible_facts['devices'] else 'Not available' }})

# Disable swap to prevent performance issues
- name: Disable swap
  ansible.builtin.command: swapoff -a
  changed_when: false

- name: Comment out swap in fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].+swap.+)'
    replace: '# \1'

# Format drives with appropriate filesystems (skip snapshots if on root)
- name: Format ledger drive
  community.general.filesystem:
    fstype: "{{ filesystem_formats.ledger }}"
    dev: "/dev/{{ ledger_disk }}"
    force: true
  when: ledger_disk != '' and ansible_facts['devices'][ledger_disk] is defined

- name: Format accounts drive
  community.general.filesystem:
    fstype: "{{ filesystem_formats.accounts }}"
    dev: "/dev/{{ account_disk }}"
    force: true
  when: account_disk != '' and ansible_facts['devices'][account_disk] is defined

- name: Format snapshots drive (skip if snapshots on root)
  community.general.filesystem:
    fstype: "{{ filesystem_formats.snapshots }}"
    dev: "/dev/{{ snapshots_disk }}"
    force: true
  when:
    - snapshots_disk != ''
    - ansible_facts['devices'][snapshots_disk] is defined
    - ansible_facts['devices'][snapshots_disk].partitions is defined
    - ansible_facts['devices'][snapshots_disk].partitions | type_debug == 'list'
    - "'/' not in (ansible_facts['devices'][snapshots_disk].partitions | map(attribute='mountpoint') | list)"

# Create mount point directories
- name: Create mount directories
  ansible.builtin.file:
    path: "{{ mount_points[item] }}"
    state: directory
    mode: "{{ mount_point_permissions.mode }}"
    owner: "{{ mount_point_permissions.owner }}"
    group: "{{ mount_point_permissions.group }}"
  loop: "{{ mount_directories }}"

# Get UUIDs for fstab configuration (skip snapshots if on root)
- name: Get UUID for ledger drive
  ansible.builtin.command: blkid -s UUID -o value "/dev/{{ ledger_disk }}"
  register: ledger_uuid
  changed_when: false
  when: ledger_disk != '' and ansible_facts['devices'][ledger_disk] is defined

- name: Get UUID for accounts drive
  ansible.builtin.command: blkid -s UUID -o value "/dev/{{ account_disk }}"
  register: accounts_uuid
  changed_when: false
  when: account_disk != '' and ansible_facts['devices'][account_disk] is defined

- name: Get UUID for snapshots drive (skip if snapshots on root)
  ansible.builtin.command: blkid -s UUID -o value "/dev/{{ snapshots_disk }}"
  register: snapshots_uuid
  changed_when: false
  when:
    - snapshots_disk != ''
    - ansible_facts['devices'][snapshots_disk].partitions is defined
    - ansible_facts['devices'][snapshots_disk].partitions | type_debug == 'list'
    - "'/' not in (ansible_facts['devices'][snapshots_disk].partitions | map(attribute='mountpoint') | list)"

# Configure fstab for automatic mounting (skip snapshots if on root)
- name: Configure fstab for ledger drive
  ansible.posix.mount:
    path: "{{ mount_points.ledger }}"
    src: "UUID={{ ledger_uuid.stdout }}"
    fstype: "{{ filesystem_formats.ledger }}"
    opts: defaults,noatime,logbufs=8,logbsize=32k
    dump: 0
    passno: 2
    state: present
  when: ledger_uuid.stdout is defined and ledger_uuid.stdout != ""

- name: Configure fstab for accounts drive
  ansible.posix.mount:
    path: "{{ mount_points.accounts }}"
    src: "UUID={{ accounts_uuid.stdout }}"
    fstype: "{{ filesystem_formats.accounts }}"
    opts: defaults,noatime
    dump: 0
    passno: 2
    state: present
  when: accounts_uuid.stdout is defined and accounts_uuid.stdout != ""

- name: Configure fstab for snapshots drive (skip if snapshots on root)
  ansible.posix.mount:
    path: "{{ mount_points.snapshots }}"
    src: "UUID={{ snapshots_uuid.stdout }}"
    fstype: "{{ filesystem_formats.snapshots }}"
    opts: defaults,noatime
    dump: 0
    passno: 2
    state: present
  when:
    - snapshots_uuid.stdout is defined
    - snapshots_uuid.stdout != ""
    - "'/' not in (ansible_facts['devices'][snapshots_disk].partitions | map(attribute='mountpoint') | list)"

# Mount all configured filesystems (snapshots on root is already mounted)
- name: Mount all filesystems
  ansible.builtin.command: mount -a
  changed_when: false

# Ensure correct ownership and permissions on mount points after mounting
- name: Set ownership and permissions on mount points after mounting
  ansible.builtin.file:
    path: "{{ mount_points[item] }}"
    mode: "{{ mount_point_permissions.mode }}"
    owner: "{{ mount_point_permissions.owner }}"
    group: "{{ mount_point_permissions.group }}"
    recurse: true
  loop: "{{ mount_directories }}"
