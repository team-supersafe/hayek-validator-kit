---
- name: Validate requested hostname format
  ansible.builtin.assert:
    that:
      - host_name | trim | length > 0
      - host_name | length <= 63
      - host_name is match('^[A-Za-z0-9]([A-Za-z0-9-]{0,61}[A-Za-z0-9])?$')
    fail_msg: >
      Invalid host_name '{{ host_name }}'. Hostname must be 1-63 characters,
      use only letters, numbers, and hyphens, and must not start or end with a hyphen.
  when:
    - host_name is defined
  tags: [restart, pre-reboot-hostname]

- name: Set system hostname
  ansible.builtin.hostname:
    name: "{{ host_name }}"
    use: systemd
  when:
    - host_name is defined
    - host_name | trim | length > 0
  tags: [restart, pre-reboot-hostname]

- name: Ensure /etc/hosts has hostname mapping
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1\s+'
    line: "127.0.1.1 {{ host_name }}"
    state: present
  when:
    - host_name is defined
    - host_name | trim | length > 0
  tags: [restart, pre-reboot-hostname]

- name: Countdown before automatic reboot
  ansible.builtin.pause:
    seconds: 10
    prompt: |
      Server reboot will start automatically in 10 seconds.

      Press Ctrl+C now to abort the playbook before reboot.
  delegate_to: localhost
  run_once: true

- name: Display reconnection instructions
  ansible.builtin.debug:
    msg: |
      -------------------------------------------------
      THE SERVER IS NOW RESTARTING

      To reconnect, please use:
      ssh {{ ansible_user }}@{{ ansible_facts['default_ipv4']['address'] }} -p {{ firewall.ssh_port }}

      Please allow a few minutes for the server to complete the restart.
      -------------------------------------------------
  run_once: true
  delegate_to: localhost

- name: Initiate server reboot
  ansible.builtin.reboot:
    reboot_timeout: 900
    connect_timeout: 5
    post_reboot_delay: 10
    test_command: whoami

- name: End playbook - Server is rebooting
  ansible.builtin.meta: end_play
