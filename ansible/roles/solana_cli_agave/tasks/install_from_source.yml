- name: Start building Agave message
  ansible.builtin.debug:
    msg: "Building Agave version {{ agave_version }} from source"

- name: Create solana cli releases directory
  ansible.builtin.file:
    path: "{{ solana_installed_releases_dir }}"
    state: directory
    mode: "0755"

- name: Set local variable for agave_build_dir
  ansible.builtin.set_fact:
    agave_build_dir: "{{ build_dir }}/agave"

- name: Set local variable for solana_installed_release_dir
  ansible.builtin.set_fact:
    solana_installed_release_dir: "{{ solana_installed_releases_dir }}/v{{ agave_version }}"

- name: Ensure agave_build_dir directory exists
  ansible.builtin.file:
    path: "{{ agave_build_dir }}"
    state: directory
    mode: "0755"

- name: Debug print Agave build directory
  ansible.builtin.debug:
    msg: "Agave build directory: {{ agave_build_dir }}"

- name: Prepare Agave source code (download and extract)
  block:
    - name: Set local boolean for repository selection
      ansible.builtin.set_fact:
        use_official_repo_bool: "{{ use_official_repo | default(false) | bool }}"

    - name: Debug repository selection for download
      ansible.builtin.debug:
        msg: "Using {{ use_official_repo_bool | ternary('official', 'forked') }} Agave repository for download: {{ use_official_repo_bool | ternary(agave_official_repo, agave_forked_repo) }}"

    - name: Set download URL based on repository selection
      ansible.builtin.set_fact:
        agave_download_url: "{{ use_official_repo_bool | ternary(agave_official_repo, agave_forked_repo) }}/archive/refs/tags/v{{ agave_version }}.tar.gz"

    - name: Debug download URL
      ansible.builtin.debug:
        msg: "Download URL: {{ agave_download_url }}"

    - name: Unarchive Agave source code from tag
      ansible.builtin.unarchive:
        src: "{{ agave_download_url }}"
        dest: "{{ agave_build_dir }}"
        remote_src: true
        creates: "{{ agave_build_dir }}/agave-{{ agave_version }}"

    - name: Parse forked repo name from agave_forked_repo URL
      ansible.builtin.set_fact:
        agave_forked_repo_name: "{{ agave_forked_repo | regex_replace('.*/', '') }}"
      when: not use_official_repo_bool

    - name: Set extracted Agave directory name
      ansible.builtin.set_fact:
        agave_extracted_dir_name: "{{ use_official_repo_bool | ternary('agave', agave_forked_repo_name) }}"

    - name: Slurp Cargo.toml to extract version
      ansible.builtin.slurp:
        src: "{{ agave_build_dir }}/{{ agave_extracted_dir_name }}-{{ agave_version }}/Cargo.toml"
      register: cargo_toml_slurp

    - name: Extract version from Cargo.toml content
      ansible.builtin.set_fact:
        cargo_toml_version: "{{ (cargo_toml_slurp.content | b64decode) | regex_search('^version\\s*=\\s*\"([^\"]+)\"', '\\1', multiline=True) }}"

    - name: Debug Cargo.toml version
      ansible.builtin.debug:
        msg: "Cargo.toml version: {{ cargo_toml_version }} | Expected: {{ agave_version }}"

    - name: Fail if Cargo.toml version does not match agave_version
      ansible.builtin.fail:
        msg: "Cargo.toml version ({{ cargo_toml_version }}) does not match expected agave_version ({{ agave_version }})!"
      when: cargo_toml_version != agave_version
      changed_when: false
      ignore_errors: "{{ ansible_check_mode }}"

- name: Create release directory for Agave
  ansible.builtin.file:
    path: "{{ solana_installed_release_dir }}"
    state: directory
    mode: "0755"

- name: Run cargo-install-all.sh
  ansible.builtin.shell: |
    set -e
    . "{{ solana_user_dir }}/.cargo/env"
    ./scripts/cargo-install-all.sh . > {{ agave_build_dir }}/agave-build.log 2>&1
  args:
    chdir: "{{ agave_build_dir }}/{{ agave_extracted_dir_name }}-{{ agave_version }}"

# The above will compile the source code and create the following:
# A bin directory, .crates.toml and .crates2.json files.
- name: Move built Agave assets into the releases directory (with failure handling)
  block:
    - name: Validate release directory path before cleanup
      ansible.builtin.assert:
        that:
          - solana_installed_release_dir is defined
          - solana_installed_release_dir != ""
          - solana_installed_release_dir != "/"
          - solana_installed_release_dir != "/home"
          - solana_installed_release_dir != "/root"
        fail_msg: "Invalid release directory path: {{ solana_installed_release_dir }}"

    - name: Clean up existing release directory contents safely
      ansible.builtin.file:
        path: "{{ solana_installed_release_dir }}"
        state: absent
      register: cleanup_result

    - name: Recreate release directory
      ansible.builtin.file:
        path: "{{ solana_installed_release_dir }}"
        state: directory
        mode: "0755"

    - name: Move agave we just built into the releases directory
      ansible.builtin.shell: |
        set -e
        mv "{{ agave_build_dir }}/{{ agave_extracted_dir_name }}-{{ agave_version }}/.crates.toml" "{{ solana_installed_release_dir }}"
        mv "{{ agave_build_dir }}/{{ agave_extracted_dir_name }}-{{ agave_version }}/.crates2.json" "{{ solana_installed_release_dir }}"
        mv "{{ agave_build_dir }}/{{ agave_extracted_dir_name }}-{{ agave_version }}/bin" "{{ solana_installed_release_dir }}"
  rescue:
    - name: Fail if moving built assets failed
      ansible.builtin.fail:
        msg: |
          Failed to move built Agave assets to the releases directory.
          Check if .crates.toml, .crates2.json, and bin exist in {{ agave_build_dir }}/{{ agave_extracted_dir_name }}-{{ agave_version }}

# Create symlink to new release
- name: Create symlink to new release
  ansible.builtin.file:
    src: "{{ solana_installed_release_dir }}"
    dest: "{{ solana_user_dir }}/.local/share/solana/install/active_release"
    state: link
    force: true
