---
- name: Precheck - Check if agave_version is defined
  ansible.builtin.fail:
    msg: "agave_version variable must be defined"
  when: agave_version is not defined

- name: Precheck - Validate agave_version format
  ansible.builtin.fail:
    msg: "agave_version must follow semantic versioning pattern (e.g. 1.2.3)"
  when: not agave_version | regex_search('^[0-9]+\.[0-9]+\.[0-9]+$')

- name: Precheck - Display version message
  ansible.builtin.debug:
    msg: "Start Solana CLI setup for version {{ agave_version }}"

- name: Precheck - Enforce build_from_source=true on production clusters
  ansible.builtin.assert:
    that:
      - build_from_source | default(true) | bool
    fail_msg: >-
      Production clusters require build_from_source=true. Received
      build_from_source={{ build_from_source | default('undefined') }}
      for solana_cluster={{ solana_cluster }}.
  when:
    - solana_cluster is defined
    - (solana_cluster | lower) in ['mainnet', 'mainnet-beta', 'testnet']

- name: Add hosts to known_hosts to comply with ansible config host_key_checking
  ansible.builtin.known_hosts:
    name: "{{ item }}"
    key: "{{ hostvars[item].ansible_ssh_hostkey_rsa_public }}"
  delegate_to: localhost
  loop: "{{ ansible_play_hosts_all }}"
  when: hostvars[item].ansible_ssh_hostkey_rsa_public is defined

- name: Check if the desired version of Solana CLI is already installed
  block:
    - name: Check if Solana CLI binary exists
      ansible.builtin.stat:
        path: "{{ system_solana_active_release_dir }}/solana"
      register: solana_binary

    - name: Precheck - Get installed Solana CLI version
      ansible.builtin.command: "{{ system_solana_active_release_dir }}/solana --version"
      register: installed_version
      changed_when: false
      failed_when: false
      when: solana_binary.stat.exists

    # Take into account client and version number
    # solana-cli 2.3.11 (src:e2b57760; feat:798020478, client:Solana)
    - name: Precheck - Extract installed version number
      ansible.builtin.set_fact:
        installed_solana_version: "{{ installed_version.stdout | regex_search('solana-cli ([0-9.]+)', '\\1') | first }}"
      when: solana_binary.stat.exists and installed_version.stdout is defined

    - name: Precheck - Extract installed client identifier
      ansible.builtin.set_fact:
        installed_solana_client: "{{ installed_version.stdout | regex_search('client:([A-Za-z0-9]+)', '\\1') | first }}"
      when: solana_binary.stat.exists and installed_version.stdout is defined

    - name: Precheck - Set fact for Solana CLI installation needed
      ansible.builtin.set_fact:
        solana_cli_already_installed: >-
          {{ solana_binary.stat.exists and
             installed_solana_version is defined and
             installed_solana_version == agave_version and
             installed_solana_client is defined and installed_solana_client == 'Solana' }}

- name: Precheck - Find solana binary in PATH
  ansible.builtin.command: which solana
  register: solana_which_result
  changed_when: false
  failed_when: false

- name: Debug installation status
  ansible.builtin.debug:
    msg: |
      Solana CLI installation status:
      - Binary exists: {{ solana_binary.stat.exists }}
      - Binary path: {{ solana_binary.stat.exists | ternary(system_solana_active_release_dir ~ '/solana', 'Not found') }}
      - Installed version: {{ installed_solana_version | default('not found') }}
      - Installed client: {{ installed_solana_client | default('not found') }}
      - Desired client: Solana
      - Desired version: {{ agave_version }}
      - Already installed: {{ solana_cli_already_installed }}
