---
# Solana CLI Installation Tasks
# This file handles architecture detection and delegates to the appropriate install method.

# Ensure the host architecture is set (required for conditional installation logic)
- import_tasks: ../../common/tasks/set_host_architecture.yml

- name: Install prerequisites
  become: true
  ansible.builtin.apt:
    name:
      - at
      - bzip2
      - build-essential
      - clang
      - cmake
      - libclang-dev
      - libprotobuf-dev
      - libssl-dev
      - libudev-dev
      - llvm
      - make
      - pkg-config
      - protobuf-compiler
      - python3-psutil
      - zlib1g-dev
    update_cache: true

# Set local boolean for build method
- name: Set local boolean for build method
  ansible.builtin.set_fact:
    build_from_source_bool: "{{ build_from_source | default(true) | bool }}"

# Choose installation method based on user preference
- when: not build_from_source_bool
  name: Install - Installing from binaries
  ansible.builtin.include_tasks: install_from_binaries.yml

- when: build_from_source_bool
  name: Install - Installing from source
  ansible.builtin.include_tasks: install_from_source.yml

# Add Jito-Solana CLI bin path to global profile for all users (test)
- name: Install - Add Jito-Solana CLI bin path to global profile
  ansible.builtin.blockinfile:
    path: /etc/profile.d/solana.sh
    create: true
    mode: '0644'
    marker: "# {mark} ANSIBLE MANAGED SOLANA ENVIRONMENT"
    block: |
      export PATH="{{ system_solana_active_release_dir }}:$PATH"
      export RPC_URL="{{ solana_rpc_url | default('http://localhost:8899') }}"
  become: true
  when: system_solana_active_release_dir is defined and system_solana_active_release_dir != ''
