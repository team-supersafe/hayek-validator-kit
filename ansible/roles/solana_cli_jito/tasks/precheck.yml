---
- name: Precheck - Assert jito_version is defined and valid
  ansible.builtin.assert:
    that:
      - jito_version is defined
      - jito_version is regex('^[0-9]+\.[0-9]+\.[0-9]+$')
    fail_msg: |
      Required variable is missing or invalid:
      - jito_version must be defined and follow semantic versioning (e.g. 1.2.3)

- name: Precheck - Display version message
  ansible.builtin.debug:
    msg: "Start Jito-Solana CLI setup for version {{ jito_version }}"

- name: Add hosts to known_hosts to comply with ansible config host_key_checking
  ansible.builtin.known_hosts:
    name: "{{ item }}"
    key: "{{ hostvars[item].ansible_ssh_hostkey_rsa_public }}"
  delegate_to: localhost
  loop: "{{ ansible_play_hosts_all }}"
  when: hostvars[item].ansible_ssh_hostkey_rsa_public is defined

- name: Check if the desired version of Jito-Solana CLI is already installed
  block:
    - name: Check if Jito-Solana CLI binary exists
      ansible.builtin.stat:
        path: "{{ validator_solana_install_dir }}/solana"
      register: solana_binary

    - name: Precheck - Get installed Jito-Solana CLI version
      ansible.builtin.command: "{{ validator_solana_install_dir }}/solana --version"
      register: installed_version
      changed_when: false
      failed_when: false
      when: solana_binary.stat.exists

    # Take into account client and version number
    # solana-cli 2.3.11 (src:e2b57760; feat:798020478, client:Solana)
    # solana-cli 3.0.6 (src:90240211; feat:3073396398, client:JitoLabs)
    - name: Precheck - Extract installed version number
      ansible.builtin.set_fact:
        installed_jito_version: "{{ installed_version.stdout | regex_search('solana-cli ([0-9.]+)', '\\1') | first }}"
      when: solana_binary.stat.exists and installed_version.stdout is defined

    - name: Precheck - Extract installed client identifier
      ansible.builtin.set_fact:
        installed_jito_client: "{{ installed_version.stdout | regex_search('client:([A-Za-z0-9]+)', '\\1') | first }}"
      when: solana_binary.stat.exists and installed_version.stdout is defined

    - name: Precheck - Set fact for Jito-Solana CLI already installed
      ansible.builtin.set_fact:
        jito_cli_already_installed: >-
          {{ solana_binary.stat.exists and
             installed_jito_version is defined and
             installed_jito_version == jito_version and
             installed_jito_client is defined and installed_jito_client == 'JitoLabs' }}

- name: Precheck - Find solana binary in PATH
  ansible.builtin.command: which solana
  register: solana_which_result
  changed_when: false
  failed_when: false

- name: Debug installation status
  ansible.builtin.debug:
    msg: |
      Jito-Solana CLI installation status:
      - Binary exists: {{ solana_binary.stat.exists }}
      - Binary path: "{{ solana_binary.stat.exists | ternary(validator_solana_install_dir ~ '/solana', 'Not found') }}"
      - Binary in PATH: {{ (solana_which_result.stdout is defined and solana_which_result.stdout | length > 0) | ternary('True', 'False') }}
      - Installed version: "{{ installed_jito_version | default('Not found') }}"
      - Installed client: "{{ installed_jito_client | default('Not found') }}"
      - Desired client: "JitoLabs"
      - Desired version: "{{ jito_version }}"
      - Already installed: {{ jito_cli_already_installed }}
