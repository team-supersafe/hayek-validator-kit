---
# verify.yml - solana_set_validator_keys

- name: Check if Jito relayer binary exists
  ansible.builtin.stat:
    path: "{{ jito_relayer_install_dir }}/jito-transaction-relayer"
  register: relayer_binary

- name: Fail if Jito relayer binary is missing
  ansible.builtin.fail:
    msg: "Jito relayer binary not found at {{ jito_relayer_install_dir }}/jito-transaction-relayer!"
  when: not relayer_binary.stat.exists

- name: Check Jito relayer systemd service status
  ansible.builtin.systemd:
    name: "{{ jito_relayer_service_name }}"
  register: relayer_service

- name: Get last 50 lines of Jito relayer logs
  ansible.builtin.shell: journalctl -u {{ jito_relayer_service_name }} --no-pager | tail -n 50
  register: relayer_logs
  changed_when: false

- name: Check Jito relayer process status
  ansible.builtin.shell: ps aux | grep jito-transaction-relayer | grep -v grep
  register: relayer_process
  changed_when: false

- name: Check if validator binary exists
  ansible.builtin.stat:
    path: "{{ solana_install_dir }}/agave-validator"
  register: validator_binary

- name: Fail if validator binary is missing
  ansible.builtin.fail:
    msg: "Validator binary not found at {{ solana_install_dir }}/agave-validator!"
  when: not validator_binary.stat.exists

- name: Check validator systemd service status
  ansible.builtin.systemd:
    name: "{{ validator_service_name }}"
  register: validator_service

- name: Get last 50 lines of validator logs
  ansible.builtin.shell: journalctl -u {{ validator_service_name }} --no-pager | tail -n 50
  register: validator_logs
  changed_when: false

- name: Check validator process status
  ansible.builtin.shell: ps aux | grep "validator" | grep -v grep
  register: validator_process
  changed_when: false

- name: Print service and process status summary
  ansible.builtin.debug:
    msg: |
      =============================
      Jito Relayer Service Status:
      - Binary exists: {{ relayer_binary.stat.exists }}
      - Service active: {{ relayer_service.status.ActiveState }}
      - Service enabled: {{ relayer_service.status.UnitFileState }}
      - Process running: {{ relayer_process.stdout_lines | length > 0 }}

      Validator Service Status:
      - Binary exists: {{ validator_binary.stat.exists }}
      - Service active: {{ validator_service.status.ActiveState }}
      - Service enabled: {{ validator_service.status.UnitFileState }}
      - Process running: {{ validator_process.stdout_lines | length > 0 }}
      =============================

- name: Print last 50 lines of Jito relayer logs
  ansible.builtin.debug:
    var: relayer_logs.stdout_lines

- name: Print last 50 lines of validator logs
  ansible.builtin.debug:
    var: validator_logs.stdout_lines

- name: Print validator monitoring hints
  ansible.builtin.debug:
    msg: |
      ===========================================================
      🚀 Validator & Jito Relayer Setup Complete! Helpful commands:
      ===========================================================
      📈 Monitor cluster validators:
      solana -ul validators --keep-unstaked-delinquents
      solana gossip -ul
      🔍 Check for running validator process:
      ps aux | grep validator
      🔄 Check for running Jito Relayer process:
      ps aux | grep jito-relayer
      📊 Monitor validator startup state:
      agave-validator -l /mnt/ledger/ monitor
      ⚡ View validator catchup status:
      solana -ul catchup --our-localhost 8899 --url http://127.0.0.1:8899
      🔍 Inspect logs:
      tail -f ~/logs/agave-validator.log
      tail -f ~/logs/agave-validator.log | grep -v 'solana_metrics::metrics'
      journalctl -u jito-relayer -f
      ===========================================================
