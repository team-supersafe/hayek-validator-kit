---
- name: precheck - Validate source and destination hosts are different
  ansible.builtin.fail:
    msg: >-
      Source and destination hosts must be different!
      Source host: {{ source_host }}
      Destination host: {{ destination_host }}
      Using the same host for both source and destination can cause data loss and unexpected behavior.
  when: source_host == destination_host
  run_once: true

- name: precheck - Validate source host validator directory
  block:
    - name: precheck - Get stats of source validator directory
      ansible.builtin.stat:
        path: "{{ source_host_keys_dir }}"
      register: source_validator_keys_dir
      when: inventory_hostname == source_host

    - name: precheck - Set source directory validation fact
      ansible.builtin.set_fact:
        source_dir_valid: >-
          {{
            source_validator_keys_dir.stat.isdir is defined and
            source_validator_keys_dir.stat.isdir
          }}
      when: inventory_hostname == source_host

- name: precheck - Validate destination host validator directory
  block:
    - name: precheck - Get stats of destination validator directory
      ansible.builtin.stat:
        path: "{{ destination_host_keys_dir }}"
      register: destination_validator_keys_dir
      when: inventory_hostname == destination_host

    - name: precheck - Set destination directory validation fact
      ansible.builtin.set_fact:
        destination_dir_valid: >-
          {{
            destination_validator_keys_dir.stat.isdir is defined and
            destination_validator_keys_dir.stat.isdir
          }}
      when: inventory_hostname == destination_host

- name: precheck - Set validation facts for all hosts
  ansible.builtin.set_fact:
    source_validation: "{{ hostvars[source_host].source_dir_valid | default(false) }}"
    destination_validation: "{{ hostvars[destination_host].destination_dir_valid | default(false) }}"

- name: precheck - Fail if either directory validation failed
  ansible.builtin.fail:
    msg: >-
      Directory validation failed:
      {% if not source_validation %}Source directory '{{ source_host_keys_dir }}' is invalid on {{ source_host }}{% endif %}
      {% if not destination_validation %}Destination directory '{{ destination_host_keys_dir }}' is invalid on {{ destination_host }}{% endif %}
  when: not (source_validation and destination_validation)
  run_once: true

- name: precheck - Ensure python3-psutil is installed
  ansible.builtin.apt:
    name: python3-psutil
    state: present
    update_cache: yes
  become: true

- name: precheck - Validate destination host validator status
  block:
    - name: precheck - Check validator systemd service status
      ansible.builtin.systemd:
        name: "{{ validator_service_name }}"
      register: validator_service
      changed_when: false

    - name: precheck - Check validator process status
      ansible.builtin.pids:
        pattern: agave-validator
      register: validator_process
      changed_when: false
      failed_when: validator_process.pids | length == 0

    - name: precheck - Assert validator systemd service is active
      ansible.builtin.assert:
        that:
          - validator_service.status.ActiveState == "active"
        fail_msg: "Validator systemd service is not active on destination host {{ destination_host }}. Current state: {{ validator_service.status.ActiveState }}"

    - name: precheck - Assert validator process is running
      ansible.builtin.assert:
        that:
          - validator_process.pids is defined
          - validator_process.pids | length > 0
        fail_msg: "Validator process is not running on destination host {{ destination_host }}"
  when: inventory_hostname == destination_host

- name: precheck - Validate validator identity matches running process
  block:
    - name: precheck - Get validator contact info and extract identity
      ansible.builtin.shell: "{{ solana_install_dir }}/agave-validator -l {{ ledger_path }} contact-info | head -1 | sed 's/Identity: //'"
      register: ledger_identity
      changed_when: false

    - name: precheck - Set ledger identity fact for host
      ansible.builtin.set_fact:
        ledger_identity_pubkey: "{{ ledger_identity.stdout | trim }}"
      when: ledger_identity is defined and ledger_identity.stdout is defined

    - name: precheck - Get running validator identity file path
      ansible.builtin.shell: "ps aux | grep agave-validator | grep -v grep | grep -o '--identity [^ ]*' | cut -d' ' -f2"
      register: running_identity_file
      changed_when: false

    - name: precheck - Get pubkey from running identity file
      ansible.builtin.command: solana-keygen pubkey {{ running_identity_file.stdout }}
      register: running_pubkey
      environment:
        PATH: "{{ solana_install_dir }}"
      changed_when: false
      when: running_identity_file.stdout != ''

    - name: precheck - Fail if identity mismatch
      ansible.builtin.fail:
        msg: >
          {{ inventory_hostname }} host identity mismatch!
          Ledger identity: {{ ledger_identity.stdout | default('N/A') }}
          Running identity pubkey: {{ running_pubkey.stdout | default('N/A') }}
          The validator service is not using the expected identity file.
      when:
        - not ansible_check_mode
        - (ledger_identity.stdout | default('')) != (running_pubkey.stdout | default(''))
        - (ledger_identity.stdout | default('')) != ''
        - (running_pubkey.stdout | default('')) != ''

- name: precheck - Set global facts for running ledger identities
  ansible.builtin.set_fact:
    source_ledger_identity: "{{ hostvars[source_host]['ledger_identity_pubkey'] | default('') }}"
    destination_ledger_identity: "{{ hostvars[destination_host]['ledger_identity_pubkey'] | default('') }}"
  run_once: true
