---
- name: Clean validator data before start
  block:
    - name: Check if validator service is running
      ansible.builtin.systemd:
        name: "{{ validator_service_name }}"
      register: service_status
      changed_when: false
      failed_when: false

    - name: Stop validator service if running
      ansible.builtin.systemd:
        name: "{{ validator_service_name }}"
        state: stopped
      when: service_status.status.ActiveState == "active"
      become: true

    - name: Reset ledger directory
      ansible.builtin.file:
        path: "{{ ledger_path }}"
        state: absent
      become: true

    - name: Ensure ledger directory exists
      ansible.builtin.file:
        path: "{{ ledger_path }}"
        state: directory
        mode: "0755"
        owner: "{{ solana_user }}"
        group: "{{ solana_user }}"
      become: true

    - name: Reset accounts directory
      ansible.builtin.file:
        path: "{{ accounts_path }}"
        state: absent
      become: true

    - name: Ensure accounts directory exists
      ansible.builtin.file:
        path: "{{ accounts_path }}"
        state: directory
        mode: "0755"
        owner: "{{ solana_user }}"
        group: "{{ solana_user }}"
      become: true

    - name: Reset snapshots directory
      ansible.builtin.file:
        path: "{{ snapshots_path }}"
        state: absent
      become: true

    - name: Ensure snapshots directory exists
      ansible.builtin.file:
        path: "{{ snapshots_path }}"
        state: directory
        mode: "0755"
        owner: "{{ solana_user }}"
        group: "{{ solana_user }}"
      become: true

    - name: Reset logs directory
      ansible.builtin.file:
        path: "{{ logs_dir }}"
        state: absent
      become: true

    - name: Ensure logs directory exists
      ansible.builtin.file:
        path: "{{ logs_dir }}"
        state: directory
        mode: "0755"
        owner: "{{ solana_user }}"
        group: "{{ solana_user }}"
      become: true
  rescue:
    - name: Fail with error message
      ansible.builtin.fail:
        msg: "Failed to clean validator data. Error: {{ ansible_failed_result }}"
