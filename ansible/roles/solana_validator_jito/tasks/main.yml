---
- name: Precheck parameters
  import_tasks: precheck.yml
  tags: [solana_validator_jito, precheck]

- name: Debug group names
  debug:
    msg: "Available groups: {{ group_names }}"

- name: Set Jito target city
  set_fact:
    jito_target_city: "{{ group_names | select('match', '^city_') | first | regex_replace('^city_', '') }}"
  ansible.builtin.fail:
    when: jito_target_city == ''
    msg: "Host {{ inventory_hostname }} must be assigned to a city group (city_dallas, city_manchester, or city_warsaw) in the inventory"

- name: Set Jito URLs
  set_fact:
    jito_relayer_url: "{{ 'http://127.0.0.1:11226' if jito_relayer_type == 'co-hosted' else jito_urls[jito_target_city].relayer }}"
    jito_block_engine_url: "{{ jito_urls[jito_target_city].block_engine }}"
    jito_shred_receiver_addr: "{{ jito_urls[jito_target_city].shred_receiver_addr }}"

- when: jito_relayer_type == 'co-hosted'
  block:
    - name: Check for Co-hosted Relayer installation
      import_tasks: jito_relayer_cohosted/install.yml
    - name: Configure Co-hosted Relayer post installation
      import_tasks: jito_relayer_cohosted/config.yml
    - name: Verify Co-hosted Relayer installation and configuration are correct
      import_tasks: jito_relayer_cohosted/verify.yml

# Jito client installation
- name: Setup Jito client
  import_tasks: jito_client/main.yml