---
- name: jito_relayer_cohosted - verify - Check if Jito relayer binary exists
  ansible.builtin.stat:
    path: "{{ jito_relayer_install_dir }}/jito-transaction-relayer"
  register: relayer_binary
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Fail if Jito relayer binary is missing
  ansible.builtin.fail:
    msg: "Jito relayer binary not found at {{ jito_relayer_install_dir }}/jito-transaction-relayer!"
  when: not relayer_binary.stat.exists
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Check Jito relayer systemd service status
  ansible.builtin.systemd:
    name: "{{ jito_relayer_service_name }}"
  register: relayer_service
  changed_when: false
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Print Jito relayer service status
  ansible.builtin.debug:
    var: relayer_service
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Get last 50 lines of Jito relayer logs
  ansible.builtin.command: journalctl -u {{ jito_relayer_service_name }} -n 50 --no-pager --since "10 seconds ago"
  register: relayer_logs
  changed_when: false
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Print last 50 lines of Jito relayer logs
  ansible.builtin.debug:
    var: relayer_logs.stdout_lines
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Check Jito relayer process status
  ansible.builtin.pids:
    pattern: jito-transaction-relayer
  register: relayer_process
  changed_when: false
  ignore_errors: true
  failed_when: false
  tags: [jito_relayer.verify]

- name: verify - Fail if jito-transaction-relayer is not running
  ansible.builtin.fail:
    msg: |
      The jito-transaction-relayer process is NOT running on {{ inventory_hostname }}.
      The relayer service failed to start, and no process was found.
      Please check the relayer logs and startup scripts for errors.
  when: relayer_process.pids | length == 0

- name: verify - Print jito-transaction-relayer process PIDs
  ansible.builtin.debug:
    var: relayer_process.pids
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Check Jito relayer service file
  ansible.builtin.slurp:
    src: /etc/systemd/system/{{ jito_relayer_service_name }}.service
  register: jito_relayer_service_file
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Print Jito relayer service file
  ansible.builtin.debug:
    msg: "{{ jito_relayer_service_file.content | b64decode }}"
  tags: [jito_relayer.verify]

- name: jito_relayer_cohosted - verify - Jito relayer verification complete
  ansible.builtin.debug:
    msg: |
      Jito relayer verification complete. Check service status and logs above for troubleshooting.
      For further monitoring, see the Jito metrics dashboard: https://grafana.metrics.jito.wtf:3000/
  tags: [jito_relayer.verify]
