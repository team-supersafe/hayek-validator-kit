---
- name: prepare - Build Jito BAM region key
  ansible.builtin.set_fact:
    jito_bam_region_key: "jito_{{ solana_cluster }}_bam_region"

- name: prepare - Set Jito BAM target region
  ansible.builtin.set_fact:
    jito_target_bam_region: "{{ hostvars[inventory_hostname][jito_bam_region_key] | default('') }}"

- name: prepare - Verify Jito BAM target region is set
  ansible.builtin.fail:
    msg: "Host {{ inventory_hostname }} must be assigned to a BAM region group (city_dal, city_man, etc.) in the inventory"
  when: jito_target_bam_region == ''

- name: prepare - Verify Jito BAM endpoint mapping exists for region
  ansible.builtin.assert:
    that:
      - jito_bam_endpoints is defined
      - jito_bam_endpoints[jito_target_bam_region] is defined
    fail_msg: "No Jito BAM endpoint mapping found for region '{{ jito_target_bam_region }}' in jito_bam_endpoints."

- name: prepare - Set Jito BAM endpoint URLs
  ansible.builtin.set_fact:
    jito_bam_url: "{{ jito_bam_endpoints[jito_target_bam_region].bam_url }}"
    jito_block_engine_url: "{{ jito_bam_endpoints[jito_target_bam_region].block_engine_url }}"
    jito_shred_receiver_addr: "{{ jito_bam_endpoints[jito_target_bam_region].shred_receiver_addr }}"

- name: prepare - Stop validator service
  block:
    - name: prepare - Check if validator service exists and is running
      ansible.builtin.systemd:
        name: "{{ validator_service_name }}"
      register: service_status
      changed_when: false
      failed_when: false

    - name: prepare - Stop validator service if running
      ansible.builtin.systemd:
        name: "{{ validator_service_name }}"
        state: stopped
        enabled: false
      register: stop_result
      retries: 3
      delay: 10
      until: stop_result is success
      when: service_status.status is defined and service_status.status.ActiveState == "active"
      become: true

- name: prepare - Stop and remove legacy relayer service if exists
  block:
    - name: prepare - legacy relayer cleanup - Build relayer service names
      ansible.builtin.set_fact:
        legacy_relayer_service_base: "{{ (jito_relayer_service_name | default('jito-relayer')) | regex_replace('\\.service$', '') }}"
        legacy_relayer_service_unit: "{{ ((jito_relayer_service_name | default('jito-relayer')) | regex_replace('\\.service$', '')) ~ '.service' }}"

    - name: prepare - legacy relayer cleanup - Check jito-relayer service status
      ansible.builtin.systemd:
        name: "{{ legacy_relayer_service_base }}"
      register: relayer_service_status
      changed_when: false
      failed_when: false

    - name: prepare - legacy relayer cleanup - Stop jito-relayer service if running
      ansible.builtin.systemd:
        name: "{{ legacy_relayer_service_base }}"
        state: stopped
        enabled: false
      register: relayer_stop_result
      retries: 3
      delay: 10
      until: relayer_stop_result is success
      when: relayer_service_status.status is defined and relayer_service_status.status.ActiveState == "active"
      become: true

    - name: prepare - legacy relayer cleanup - Remove jito-relayer service unit file
      ansible.builtin.file:
        path: "/etc/systemd/system/{{ legacy_relayer_service_unit }}"
        state: absent
      become: true

    - name: prepare - legacy relayer cleanup - Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
      become: true

# Block 1: Remove parameterized logrotate config and systemd units
- name: prepare - Remove parameterized validator logrotate config and systemd units
  block:
    - name: prepare - Remove parameterized validator logrotate config if it exists
      ansible.builtin.file:
        path: "/etc/logrotate.d/{{ validator_service_name }}"
        state: absent

    - name: prepare - Remove parameterized validator logrotate systemd service if it exists
      ansible.builtin.file:
        path: "/etc/systemd/system/validator-logrotate-{{ validator_service_name }}.service"
        state: absent

    - name: prepare - Remove parameterized validator logrotate systemd timer if it exists
      ansible.builtin.file:
        path: "/etc/systemd/system/validator-logrotate-{{ validator_service_name }}.timer"
        state: absent
  become: true

# Block 2: Remove legacy logrotate config and systemd units (old convention)
- name: prepare - Remove legacy validator logrotate config and systemd units (backward compatibility)
  block:
    - name: prepare - Remove legacy validator logrotate config if it exists
      ansible.builtin.file:
        path: /etc/logrotate.d/validator.logrotate
        state: absent

    - name: prepare - Remove legacy validator logrotate systemd service if it exists
      ansible.builtin.file:
        path: /etc/systemd/system/validator-logrotate.service
        state: absent

    - name: prepare - Remove legacy validator logrotate systemd timer if it exists
      ansible.builtin.file:
        path: /etc/systemd/system/validator-logrotate.timer
        state: absent
  become: true

- name: prepare - Clear logs and key store
  ansible.builtin.shell: |
    #!/bin/bash
    set -e

    rm -rf "{{ validator_logs_dir }}"/*
    rm -rf "{{ validator_scripts_dir }}"/*
    rm -rf "{{ validator_keys_dir }}"/*
  become: true
