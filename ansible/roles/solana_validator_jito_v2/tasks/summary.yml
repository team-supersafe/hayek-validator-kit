---
- name: prepare - Validate RPC_URL for localnet
  ansible.builtin.fail:
    msg: "RPC_URL environment variable is required for solana_localnet"
  when:
    - ('solana_localnet' in group_names or ('solana_mainnet' not in group_names and 'solana_testnet' not in group_names))
    - solana_cluster_param | default('') | regex_search('--url $') | bool
  run_once: true

- name: prepare - Determine Solana cluster parameter
  ansible.builtin.set_fact:
    solana_cluster_param: >-
      {%- if 'solana_mainnet' in group_names -%}
      -um
      {%- elif 'solana_testnet' in group_names -%}
      -ut
      {%- else -%}
      --url {{ lookup('env', 'RPC_URL') | default('') }}
      {%- endif -%}
  run_once: true

# Check final disk space usage
- name: Check final disk space usage
  block:
    - name: Get current disk space
      ansible.builtin.shell: |
        df -h "{{ solana_user_dir }}" | awk 'NR==2 {print $4}'
      register: final_space
      changed_when: false

    - name: Calculate space used
      ansible.builtin.set_fact:
        space_used: "{{ initial_space.stdout | regex_replace('^([0-9]+)([KMG])$', '\\1') | int - final_space.stdout | regex_replace('^([0-9]+)([KMG])$', '\\1') | int }}"

    - name: Print space usage summary
      ansible.builtin.debug:
        msg: |
          Disk space usage summary:
          - Initial available space: {{ initial_space.stdout }}
          - Final available space: {{ final_space.stdout }}
          - Space used: {{ space_used }}G
          - Minimum required space (experimental): {{ min_required_space }}

# Display helpful hints for monitoring
- name: Display validator monitoring hints
  debug:
    msg: |
      ===========================================================
      ğŸš€ Validator Setup Complete! Here are some helpful commands:
      ===========================================================

      ğŸ“ˆ Monitor cluster validators (including delinquent ones):
      solana validators {{ solana_cluster_param }} --keep-unstaked-delinquents
      solana gossip {{ solana_cluster_param }}

      ğŸ“± Log-in to {{ inventory_hostname }} via SSH:
      ssh -p {{ ansible_port }} {{ ansible_user }}@{{ inventory_hostname }}

      ğŸ” Check for running validator process:
      ps aux | grep validator

      ğŸ”„ Check for running Jito Relayer process (if installed):
      ps aux | grep jito-relayer

      ğŸ“Š Monitor validator startup state:
      agave-validator -l /mnt/ledger/ monitor

      âš¡ View validator catchup status:
      solana catchup {{ solana_cluster_param }} --our-localhost 8899

      ğŸ” Inspect logs:
      tail -f {{ validator_logs_dir }}/agave-validator.log
      Inspect Jito Relayer logs
      journalctl -u {{ jito_relayer_service_name }} -f

      ====================================================
