---
- name: prepare - Determine Solana cluster parameter
  ansible.builtin.import_tasks: ../../solana_validator_shared/tasks/determine_solana_cluster_param.yml

# Check final disk space usage
- name: Check final disk space usage
  block:
    - name: Get current disk space
      ansible.builtin.shell: |
        df -h "{{ solana_user_dir }}" | awk 'NR==2 {print $4}'
      register: final_space
      changed_when: false

    - name: Calculate space used
      ansible.builtin.set_fact:
        space_used: "{{ initial_space.stdout | regex_replace('^([0-9]+)([KMG])$', '\\1') | int - final_space.stdout | regex_replace('^([0-9]+)([KMG])$', '\\1') | int }}"

    - name: Print space usage summary
      ansible.builtin.debug:
        msg: |
          Disk space usage summary:
          - Initial available space: {{ initial_space.stdout }}
          - Final available space: {{ final_space.stdout }}
          - Space used: {{ space_used }}G
          - Minimum required space (experimental): {{ min_required_space }}

# Display helpful hints for monitoring
- name: Display validator monitoring hints
  debug:
    msg: |
      ===========================================================
      ğŸš€ Validator Setup Complete! Here are some helpful commands:
      ===========================================================

      ğŸ“± Log-in to {{ inventory_hostname }} via SSH:
      ssh -p {{ ansible_port }} {{ ansible_user }}@{{ inventory_hostname }}

      ğŸ‘¤ Switch to sol user shell:
      sudo -u sol -i

      ğŸ“ˆ Monitor cluster validators (including delinquent ones):
      solana validators {{ solana_cluster_param }} --keep-unstaked-delinquents
      solana gossip {{ solana_cluster_param }}

      ğŸ” Check for running validator process:
      ps aux | grep validator

      ğŸ”„ Check for running Jito Relayer process (if installed):
      ps aux | grep jito-relayer

      ğŸ“Š Monitor validator startup:
      agave-validator -l {{ ledger_path }} monitor

      âš¡ View validator catchup status:
      solana catchup {{ solana_cluster_param }} --our-localhost 8899

      ğŸ” Inspect logs:
      tail -f {{ validator_logs_dir }}/agave-validator.log
      Inspect Jito Relayer logs
      journalctl -u {{ jito_relayer_service_name }} -f

      ====================================================
