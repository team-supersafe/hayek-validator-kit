---
- name: xdp - Shared preflight and runtime params
  tags: [xdp, xdp_preflight, xdp_config]
  block:
    - name: xdp - Get installed Solana CLI version
      ansible.builtin.command: "{{ system_solana_active_release_dir }}/solana --version"
      register: installed_version
      changed_when: false
      failed_when: false

    - name: xdp - Extract installed version number
      ansible.builtin.set_fact:
        xdp_validator_version: "{{ installed_version.stdout | regex_search('solana-cli ([0-9.]+)', '\\1') | first }}"
      when: installed_version.stdout is defined

    - name: xdp - Set fallback version when detection is unavailable
      ansible.builtin.set_fact:
        xdp_validator_version: "0.0.0"
      when: xdp_validator_version is not defined

    - name: xdp - Debug version detection
      ansible.builtin.debug:
        msg: |
          XDP validator version detection:
          - "binary_path={{ system_solana_active_release_dir }}/solana"
          - "version_cmd_rc={{ installed_version.rc | default(-1) }}"
          - "version_cmd_stdout={{ installed_version.stdout | default('') }}"
          - "detected_binary_version={{ xdp_validator_version }}"
      when: xdp_debug_enabled | default(false) | bool

    - name: xdp - Collect kernel version
      ansible.builtin.command: uname -r
      register: xdp_uname_result
      changed_when: false
      failed_when: false

    - name: xdp - Check bpffs path
      ansible.builtin.stat:
        path: /sys/fs/bpf
      register: xdp_bpffs_stat

    - name: xdp - Check required network tools
      ansible.builtin.shell: "command -v {{ item }}"
      loop:
        - ip
        - ethtool
      register: xdp_required_tool_checks
      changed_when: false
      failed_when: false

    - name: xdp - Probe XDP flags through agave-validator parser
      ansible.builtin.shell: "{{ system_solana_active_release_dir }}/agave-validator --version {{ item.arg }}"
      loop:
        - { name: "xdp_mode", arg: "--xdp-mode {{ xdp_mode | default('native') }}" }
        - { name: "xdp_short", arg: "--xdp" }
        - { name: "xdp_enable", arg: "--enable-xdp" }
        - { name: "xdp_enabled", arg: "--xdp-enabled" }
        - { name: "exp_retransmit_cpu", arg: "--experimental-retransmit-xdp-cpu-cores {{ xdp_experimental_retransmit_xdp_cpu_cores | default(1) }}" }
        - { name: "exp_retransmit_zero_copy", arg: "--experimental-retransmit-xdp-zero-copy" }
      register: xdp_flag_probe_results
      changed_when: false
      failed_when: false

    - name: xdp - Debug XDP parser probe results
      ansible.builtin.debug:
        var: xdp_flag_probe_results.results
      when: xdp_debug_enabled | default(false) | bool

    - name: xdp - Compute support primitives
      ansible.builtin.set_fact:
        xdp_kernel_semver: "{{ xdp_uname_result.stdout | regex_search('^[0-9]+\\.[0-9]+\\.[0-9]+') | default('0.0.0') }}"
        xdp_flag_support_mode: >-
          {{
            (
              (
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_mode') | map(attribute='stdout') | first | default(''))
                ~ ' ' ~
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_mode') | map(attribute='stderr') | first | default(''))
              ) is not search('unexpected argument|found argument .*which wasn.t expected|unrecognized option|unknown argument')
            )
            and
            (
              (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_mode') | map(attribute='rc') | first | default(1)) == 0
            )
          }}
        xdp_flag_support_short: >-
          {{
            (
              (
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_short') | map(attribute='stdout') | first | default(''))
                ~ ' ' ~
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_short') | map(attribute='stderr') | first | default(''))
              ) is not search('unexpected argument|found argument .*which wasn.t expected|unrecognized option|unknown argument')
            )
            and
            (
              (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_short') | map(attribute='rc') | first | default(1)) == 0
            )
          }}
        xdp_flag_support_enable: >-
          {{
            (
              (
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_enable') | map(attribute='stdout') | first | default(''))
                ~ ' ' ~
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_enable') | map(attribute='stderr') | first | default(''))
              ) is not search('unexpected argument|found argument .*which wasn.t expected|unrecognized option|unknown argument')
            )
            and
            (
              (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_enable') | map(attribute='rc') | first | default(1)) == 0
            )
          }}
        xdp_flag_support_enabled: >-
          {{
            (
              (
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_enabled') | map(attribute='stdout') | first | default(''))
                ~ ' ' ~
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_enabled') | map(attribute='stderr') | first | default(''))
              ) is not search('unexpected argument|found argument .*which wasn.t expected|unrecognized option|unknown argument')
            )
            and
            (
              (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'xdp_enabled') | map(attribute='rc') | first | default(1)) == 0
            )
          }}
        xdp_flag_support_exp_retransmit_cpu: >-
          {{
            (
              (
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'exp_retransmit_cpu') | map(attribute='stdout') | first | default(''))
                ~ ' ' ~
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'exp_retransmit_cpu') | map(attribute='stderr') | first | default(''))
              ) is not search('unexpected argument|found argument .*which wasn.t expected|unrecognized option|unknown argument')
            )
            and
            (
              (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'exp_retransmit_cpu') | map(attribute='rc') | first | default(1)) == 0
            )
          }}
        xdp_flag_support_exp_retransmit_zero_copy: >-
          {{
            (
              (
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'exp_retransmit_zero_copy') | map(attribute='stdout') | first | default(''))
                ~ ' ' ~
                (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'exp_retransmit_zero_copy') | map(attribute='stderr') | first | default(''))
              ) is not search('unexpected argument|found argument .*which wasn.t expected|unrecognized option|unknown argument')
            )
            and
            (
              (xdp_flag_probe_results.results | selectattr('item.name', 'equalto', 'exp_retransmit_zero_copy') | map(attribute='rc') | first | default(1)) == 0
            )
          }}
        xdp_missing_tools: >-
          {{ xdp_required_tool_checks.results
            | default([])
            | rejectattr('rc', 'equalto', 0)
            | map(attribute='item')
            | list }}

    - name: xdp - Compute aggregate flag support
      ansible.builtin.set_fact:
        xdp_any_flag_supported: >-
          {{
            xdp_flag_support_mode
            or xdp_flag_support_short
            or xdp_flag_support_enable
            or xdp_flag_support_enabled
            or xdp_flag_support_exp_retransmit_cpu
            or xdp_flag_support_exp_retransmit_zero_copy
          }}

    - name: xdp - Compute support skip reasons
      ansible.builtin.set_fact:
        xdp_skip_reasons: >-
          {{
            []
            + (['xdp_disabled'] if not (xdp_enabled | bool) else [])
            + (['validator_version_unsupported'] if not (xdp_validator_version is version(xdp_min_supported_version, '>=')) else [])
            + (['xdp_flags_unavailable'] if not (xdp_any_flag_supported | bool) else [])
            + (['kernel_too_old'] if not (xdp_kernel_semver is version(xdp_min_kernel_version, '>=')) else [])
            + (['bpffs_unavailable'] if not (xdp_bpffs_stat.stat.exists | default(false)) else [])
            + (['missing_tools_' ~ (xdp_missing_tools | join('_'))] if (xdp_missing_tools | length > 0) else [])
          }}

    - name: xdp - Build XDP CLI params
      ansible.builtin.set_fact:
        xdp_params: >-
          {{
            (
              ['--experimental-retransmit-xdp-cpu-cores ' ~ ((xdp_experimental_retransmit_xdp_cpu_cores | default(1)) | string)]
              +
              (['--experimental-retransmit-xdp-zero-copy'] if (xdp_experimental_retransmit_xdp_zero_copy | default(true) | bool) and (xdp_flag_support_exp_retransmit_zero_copy | bool) else [])
            ) if ((xdp_skip_reasons | length == 0) and (xdp_flag_support_exp_retransmit_cpu | bool))
            else (
              ['--xdp-mode ' ~ (xdp_mode | default('native'))] if ((xdp_skip_reasons | length == 0) and (xdp_flag_support_mode | bool))
              else (['--xdp'] if ((xdp_skip_reasons | length == 0) and (not xdp_flag_support_mode) and (xdp_flag_support_short | bool))
              else (['--enable-xdp'] if ((xdp_skip_reasons | length == 0) and (not xdp_flag_support_mode) and (not xdp_flag_support_short) and (xdp_flag_support_enable | bool))
              else (['--xdp-enabled'] if ((xdp_skip_reasons | length == 0) and (not xdp_flag_support_mode) and (not xdp_flag_support_short) and (not xdp_flag_support_enable) and (xdp_flag_support_enabled | bool))
              else [])))
            )
          }}

    - name: xdp - Derive effective XDP status from params
      ansible.builtin.set_fact:
        xdp_effective_enabled: "{{ (xdp_skip_reasons | length == 0) and (xdp_params | length > 0) }}"
        xdp_skip_reason: "{{ (xdp_skip_reasons | first) if (xdp_skip_reasons | length > 0) else '' }}"

    - name: xdp - Merge XDP params into extra_params
      ansible.builtin.set_fact:
        extra_params: "{{ (extra_params | default([])) + xdp_params }}"
      when: xdp_effective_enabled | bool

    - name: xdp - Warn when XDP is not effectively enabled
      ansible.builtin.debug:
        msg: >-
          XDP was requested but is not active for {{ validator_name }}.
          reason={{ xdp_skip_reason }},
          validator_version={{ xdp_validator_version }},
          kernel={{ xdp_kernel_semver }}.
      when: not (xdp_effective_enabled | bool)

    - name: xdp - Report effective XDP configuration
      ansible.builtin.debug:
        msg: >-
          XDP effective={{ xdp_effective_enabled }},
          params={{ xdp_params | default([]) }},
          mode={{ xdp_mode }},
          validator_version={{ xdp_validator_version }},
          kernel={{ xdp_kernel_semver }}.
