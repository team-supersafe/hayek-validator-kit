---
# Detect if the validator deployment is RBAC-enabled (new style) or legacy (old style)
# In a legacy deployment, the validator_root_dir does not exist and cargo_home/rustup_home are undefined or under validator-specific paths
# In an RBAC-enabled deployment, validator_root_dir lives below /opt and cargo_home/rustup_home are system-wide under /usr/local
- name: Assert validator_root_dir is defined
  ansible.builtin.assert:
    that:
      - validator_root_dir is defined
      - validator_root_dir | length > 0
    fail_msg: "validator_root_dir is not defined. Make sure the host is assigned to a group with the required group_vars (e.g., solana or solana_localnet)."

- name: Detect if validator_root_dir exists
  ansible.builtin.stat:
    path: "{{ validator_root_dir }}"
  register: validator_opt_dir

- name: Detect if {{ cargo_home }} exists
  ansible.builtin.stat:
    path: "{{ cargo_home }}"
  register: validator_cargo_dir

- name: Detect if {{ rustup_home }} exists
  ansible.builtin.stat:
    path: "{{ rustup_home }}"
  register: validator_rustup_dir

- name: Set validator_rbac_enabled flag
  ansible.builtin.set_fact:
    validator_rbac_enabled: >-
      {{
        validator_opt_dir.stat.isdir is defined and validator_opt_dir.stat.isdir
        and validator_cargo_dir.stat.isdir is defined and validator_cargo_dir.stat.isdir
        and validator_rustup_dir.stat.isdir is defined and validator_rustup_dir.stat.isdir
      }}
