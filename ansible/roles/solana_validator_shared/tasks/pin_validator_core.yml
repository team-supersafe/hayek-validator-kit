---
- name: Inform the operator about PoH pinning wait and manual override
  debug:
    msg: |
      Waiting to pin the PoH (Proof of History) thread to CPU {{ poh_pinned_cpu_core | default(2) }}.
      This will happen automatically as soon as the validator is caught up and starts voting.
      You can interrupt this process at any time with Ctrl+C.
      To retry manually later, run:
        {{ validator_scripts_dir }}/fix_core_affinity_bug_for_poh.sh {{ solana_user }} {{ poh_pinned_cpu_core | default(2) }}
      This wait may take up to about an hour on testnet/mainnet, depending on network conditions.

- name: Pin validator process to CPU core
  command: "{{ validator_scripts_dir }}/fix_core_affinity_bug_for_poh.sh {{ solana_user }} {{ poh_pinned_cpu_core | default(2) }}"
  become: true
  register: pin_core_result
  changed_when: "'Successfully set affinity' in pin_core_result.stdout"
  failed_when: false  # Result is handled in the next task
  tags:
    - poh_core_affinity
    - validator_tuning

- name: Show script result
  debug:
    msg: |
      stdout: {{ pin_core_result.stdout | default('(empty)') }}
      stderr: {{ pin_core_result.stderr | default('(empty)') }}
  when: (pin_core_result.stdout | length > 0) or (pin_core_result.stderr | length > 0)
  tags:
    - poh_core_affinity
    - validator_tuning

- name: Fail if script did not succeed
  fail:
    msg: "Script failed with rc={{ pin_core_result.rc }}. Check logs above."
  when: pin_core_result.rc != 0
  tags:
    - poh_core_affinity
    - validator_tuning
