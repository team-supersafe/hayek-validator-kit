---
# Test cron permissions
# Expected: sysadmin, validator_admin, validator_operator can stop cron

- name: Test sudo permissions for cron stop
  ansible.builtin.shell:
    cmd: "timeout {{ timeout_sec }} sudo {{ '-n' if not (is_sysadmin | default(false)) else '' }} systemctl stop cron"
    executable: /bin/bash
  register: cron_stop_result
  ignore_errors: true
  become: "{{ is_sysadmin | bool }}"

- name: Display cron stop result
  ansible.builtin.debug:
    msg: "User {{ ansible_user }} - Attempt to stop cron service: {{ 'SUCCESS' if cron_stop_result.rc == 0 else 'FAILED' }}"

- name: Wait 5 seconds if service was stopped
  ansible.builtin.pause:
    seconds: 5
  when: cron_stop_result.rc == 0

- name: Restart cron service if it was stopped
  ansible.builtin.shell:
    cmd: "timeout {{ timeout_sec }} sudo {{ '-n' if not is_sysadmin else '' }} systemctl start cron"
    executable: /bin/bash
  when: cron_stop_result.rc == 0
  ignore_errors: true
  become: "{{ is_sysadmin | bool }}"

- name: Display cron restart message
  ansible.builtin.debug:
    msg: "Cron service restarted after 5 seconds"
  when: cron_stop_result.rc == 0

